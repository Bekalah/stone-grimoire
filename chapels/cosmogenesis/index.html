<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Temple -- Cosmogenesis (Standalone)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--bg:#0b0a0e;--ink:#e8e4f1;--line:#2c2640;--wash:#151225}
  html,body{margin:0;height:100%}
  body{background:radial-gradient(1200px 600px at 50% 0%, #17132a 0%, #0b0a0e 65%); color:var(--ink); font:18px/1.6 Georgia,"Iowan Old Style",serif}
  header,.wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{margin-top:12px;background:var(--wash);border:1px solid var(--line);border-radius:12px}
  h1{margin:.2rem 0 .4rem;font-weight:600}
  #hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button{font:16px/1 ui-sans-serif,system-ui;padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#0f0d1d;color:#e8e4f1}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:.15rem .6rem;background:#120f21}
  .canvas-frame{position:relative; margin:12px 0; border-radius:12px; overflow:hidden; border:1px solid var(--line); box-shadow:0 10px 40px rgba(0,0,0,.35)}
  #fractal{width:100%;height:58vh; display:block; background:#08070c}
  .tiny{font-size:.9rem;color:#bfb9d4}
</style>
</head>
<body>
<header>
  <h1>Temple -- Cosmogenesis (Standalone)</h1>
  <p>Fractal cosmograms + harmonic beats tied to Aeons/Spheres. ND‑safe (no strobe, soft fades).</p>
  <div id="hud">
    <label>Aeon:
      <select id="aeonSel" aria-label="Select Aeon/Sphere"></select>
    </label>
    <button id="play" aria-label="Start sound and animation">Start</button>
    <button id="stop" aria-label="Stop sound and animation">Stop</button>
    <span id="readout" class="pill" aria-live="polite">--</span>
  </div>
</header>

<div class="wrap">
  <div class="canvas-frame">
    <canvas id="fractal" role="img" aria-label="Living fractal cosmogram"></canvas>
  </div>
  <p class="tiny">Audio activates on click. Headphones recommended. Smooth envelopes; gentle limiter; optional cathedral reverb if IR file present.</p>
</div>

<script type="module">
  // Standalone deps ONLY:
  import { startFractal } from "/assets/js/engines/fractal-engine.js";
  import { startBeat, stopBeat, setBpm } from "/assets/js/engines/beat-engine.js";
  import { ensureAudio, primeAudio, startTone, stopTone, setHz, loadIR } from "/assets/js/ambient-engine.js";

  const sel = document.getElementById('aeonSel');
  const btnPlay = document.getElementById('play');
  const btnStop = document.getElementById('stop');
  const readout = document.getElementById('readout');
  const cv = document.getElementById('fractal');

  // Load minimal scene data
  const scenes = await fetch("/assets/data/scenes.json",{cache:'no-store'}).then(r=>r.json());
  const aeons = scenes.aeons;

  // Populate the selector
  for (const a of aeons){
    const o = document.createElement('option');
    o.value = a.id; o.textContent = a.title;
    sel.appendChild(o);
  }
  sel.value = aeons.find(a=>a.id==="tiphereth") ? "tiphereth" : aeons[0].id;

  let fractal;
  let current = aeons.find(a=>a.id===sel.value) || aeons[0];

  const kindMap = { spiral:0, mandorla:1, kaleid:2, rings:3, cone:4 };

  function setScene(a){
    current = a;
    setHz(a.toneHz, 160);
    setBpm(a.bpm);
    fractal.set({
      hz: a.toneHz,
      bpm: a.bpm,
      detail: a.fractal.detail,
      glow: a.fractal.glow,
      hue: a.fractal.hue,
      kind: (kindMap[a.fractal.kind] ?? 0)
    });
    readout.textContent = `${a.title} · ${a.bpm}bpm · ${a.toneHz}Hz`;
  }

  async function boot(){
    await ensureAudio();
    await primeAudio(current.toneHz);
    // Optional IR (if file exists); otherwise it stays dry automatically
    try { await loadIR('/assets/audio/ir/cathedral_small.wav'); } catch {}
    fractal = await startFractal(cv, {
      hz: current.toneHz,
      bpm: current.bpm,
      detail: current.fractal.detail,
      glow: current.fractal.glow,
      hue: current.fractal.hue,
      kind: (kindMap[current.fractal.kind] ?? 0)
    });
  }
  boot();

  sel.addEventListener('change', ()=>{
    const a = aeons.find(x=>x.id===sel.value) || current;
    setScene(a);
  });

  btnPlay.addEventListener('click', async ()=>{
    await ensureAudio();
    startTone(current.toneHz);
    startBeat({ bpmIn: current.bpm, toneHz: current.toneHz });
  });

  btnStop.addEventListener('click', ()=>{
    stopBeat();
    stopTone();
  });
</script>
</body>
</html>