<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>✦ Living Sculpture Fusion -- Cathedral Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A museum-grade chapel that blends archetypes and realms (Shem Ladder, stylepacks, numerology, I Ching, planetary hour) into a living, ND-safe sculpture.">

<!-- Optional house styles (will gracefully degrade if absent) -->
<link rel="stylesheet" href="../assets/css/palette.css">
<link rel="stylesheet" href="../assets/css/light.css">

<style>
  :root{
    --bg: #f8f5ef; --ink:#1a1613; --line:#d9cfbf; --gold:#d4af37; --accent:#2f5a9e;
    --panel:#ffffff;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:18px/1.6 Georgia,serif}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:1120px;margin:0 auto;padding:28px}
  header{display:flex;flex-wrap:wrap;align-items:flex-end;gap:10px}
  h1{font-size:1.6rem;margin:0;color:var(--accent)}
  .meta{color:#6b6257;border-left:3px solid var(--gold);padding-left:.6rem}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .panel h2{font-size:1.05rem;margin:.2rem 0 .6rem 0;color:#3b3a34}
  label{display:block;font-size:.9rem;margin:.5rem 0 .2rem;color:#4b453f}
  input,select,textarea,button{
    font:inherit
  }
  select, input[type="number"], input[type="text"], textarea{
    width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff
  }
  textarea{min-height:80px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1 1 120px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin:.3rem 0 .6rem}
  .chip{display:inline-block;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;font-size:.9rem;background:#fff}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#fff;color:#1a1613;border:1px solid var(--line)}
  .canvas-wrap{position:relative;min-height:460px}
  canvas{width:100%;height:520px;display:block;border:1px solid var(--line);border-radius:12px;background:#ffffff}
  .plaque dl{display:grid;grid-template-columns:130px 1fr;gap:8px}
  .plaque dt{font-variant:small-caps;letter-spacing:.05em;color:#4b453f}
  .plaque dd{margin:0}
  .note{font-size:.92rem;color:#5b544c}
  footer{margin-top:24px;text-align:center;color:#5a534b}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}
  /* Planetary tints (gentle) */
  .t-moon { filter: hue-rotate(210deg) saturate(0.9) brightness(1.03); }
  .t-venus{ filter: hue-rotate(300deg) saturate(1.1) brightness(1.02); }
  .t-sun  { filter: hue-rotate( 20deg) saturate(1.05) brightness(1.05); }
  .t-mercury{filter: hue-rotate(180deg) saturate(1.0) brightness(1.0); }
  .t-jupiter{filter: hue-rotate( 40deg) saturate(1.2) brightness(1.08); }
  .t-mars { filter: hue-rotate(350deg) saturate(1.2) brightness(1.0); }
  .t-saturn{filter: hue-rotate( 60deg) saturate(0.85) brightness(0.98); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Living Sculpture Fusion</h1>
    <p class="meta">A chapel to braid archetypes and realms into a single, breathing artwork. ND-safe. No autoplay. Museum-grade.</p>
  </header>

  <div class="grid">
    <!-- Left column: controls -->
    <aside class="panel" aria-labelledby="controlsTitle">
      <h2 id="controlsTitle">Controls</h2>

      <!-- Archetype blend -->
      <label for="angelA">Archetype A (Shem Ladder)</label>
      <select id="angelA" aria-describedby="angelHelp"><option value="">Loading angels72.json…</option></select>
      <label for="angelB">Archetype B (Shem Ladder)</label>
      <select id="angelB"><option value="">(optional)</option></select>
      <p id="angelHelp" class="note">Choose one or two Shem entries to blend. If angels72.json is missing, you can type names in Notes below.</p>

      <!-- Realm / Stylepack -->
      <label for="stylepack">Realm Skin (Stylepack)</label>
      <select id="stylepack"><option value="">Loading stylepacks.json…</option></select>

      <!-- I Ching + Numerology -->
      <div class="row">
        <div>
          <label for="hex">I Ching Hexagram (1-64)</label>
          <input id="hex" type="number" min="1" max="64" placeholder="e.g., 31">
        </div>
        <div>
          <label for="numKey">Numerology Key</label>
          <select id="numKey">
            <option value="">--</option>
            <option>11</option><option>22</option><option>33</option>
            <option>72</option><option>99</option><option>144</option>
          </select>
        </div>
      </div>
      <nav aria-label="Resonance Keys" class="chips">
        <span class="chip">11</span><span class="chip">22</span><span class="chip">33</span>
        <span class="chip">72</span><span class="chip">99</span><span class="chip">144</span>
      </nav>

      <!-- Planetary hour (manual select if engine missing) -->
      <label for="planet">Planetary Current</label>
      <select id="planet">
        <option>Moon</option><option>Venus</option><option>Sun</option>
        <option>Mercury</option><option>Jupiter</option><option>Mars</option><option>Saturn</option>
      </select>

      <!-- Notes (lineage, intent) -->
      <label for="notes">Curator Notes (lineage, intent)</label>
      <textarea id="notes" placeholder="Lineage cites (e.g., Liber 777, Splendor Solis plate N), method, variations."></textarea>

      <!-- Actions -->
      <div class="bar" role="group" aria-label="Actions">
        <button class="btn" id="renderBtn">Render Sculpture</button>
        <button class="btn secondary" id="startTone">Start Tone</button>
        <button class="btn secondary" id="stopTone" disabled>Stop</button>
        <button class="btn secondary" id="saveBtn">Save</button>
        <button class="btn secondary" id="exportBtn">Export JSON</button>
      </div>

      <!-- Tint -->
      <div class="bar" aria-label="Tints">
        <button class="btn secondary" data-tint="moon">Moon</button>
        <button class="btn secondary" data-tint="venus">Venus</button>
        <button class="btn secondary" data-tint="sun">Sun</button>
        <button class="btn secondary" data-tint="mercury">Mercury</button>
        <button class="btn secondary" data-tint="jupiter">Jupiter</button>
        <button class="btn secondary" data-tint="mars">Mars</button>
        <button class="btn secondary" data-tint="saturn">Saturn</button>
      </div>
    </aside>

    <!-- Right column: canvas + plaque -->
    <main>
      <section class="panel canvas-wrap" aria-labelledby="sculptTitle">
        <h2 id="sculptTitle" class="sr-only">Sculpture</h2>
        <canvas id="stage" width="1280" height="720" aria-label="Generative sacred canvas"></canvas>
        <p class="note">If the house fractal/cymatic engines are available they will be used; otherwise, a high-quality fallback renderer draws sacred layers (ladder, rose, vault) with glazes.</p>
      </section>

      <section class="panel plaque" aria-labelledby="plaqueTitle">
        <h2 id="plaqueTitle">Curator Plaque</h2>
        <dl id="plaque">
          <dt>Intention</dt><dd id="plaq-intent">Blend two Shem archetypes within a chosen realm skin to birth a living sculpture.</dd>
          <dt>Technique</dt><dd id="plaq-tech">Stylepack overlays + numerology modulation + hexagram lattice; ND-safe tone (manual).</dd>
          <dt>Lineage</dt><dd id="plaq-lineage">Shem ha-Mephorash, Liber 777, Sepher Sephiroth; Soyga logic; I Ching (line binary); temple styles, Rosslyn tracery.</dd>
          <dt>Evidence</dt><dd id="plaq-evidence">angels72.json, stylepacks.json; local JSON export from this room.</dd>
          <dt>Reflection</dt><dd id="plaq-reflect">Record sensations, failures, color-sound mismatches, and future refinements.</dd>
        </dl>
      </section>

      <nav class="panel" aria-label="Navigation">
        ← <a href="../cathedral.html">Back to Cathedral</a> ·
        <a href="../angels72.html">Angels Ladder</a> ·
        <a href="../folios/folio1.html">Folio Shelf</a> ·
        <a href="../standards/README.md">Standards (Charter)</a>
      </nav>
    </main>
  </div>

  <footer>
    ❦ Living Sculpture Fusion -- Chapel ❦<br>
    93 93/93
  </footer>
</div>

<script type="module">
/*
  ✦ Living Sculpture Fusion -- Cathedral Room
  Goal: pull from what's already in OTHER directories (assets/data, assets/js/*),
  gracefully detect engines, and never break if a module is missing.
  - angels72.json → archetype options
  - stylepacks.json → realm skins
  - optional: assets/js/planetary-light.js (or engines/planetary-hours.js)
  - optional: assets/js/engines/fractal-engine.js or cymatic-engine.js
  - helpers/cathedral-helper.js → ND-safe helpers if present
*/

const state = {
  angelA: null,
  angelB: null,
  stylepack: null,
  hex: null,
  numKey: null,
  planet: "Moon",
  notes: "",
  angels: [],
  stylepacks: {},
  engines: {
    helper: null,
    fractal: null,
    planetary: null
  },
  audio: {
    ctx: null, osc: null, gain: null
  }
};

const els = {
  angelA: document.getElementById("angelA"),
  angelB: document.getElementById("angelB"),
  stylepack: document.getElementById("stylepack"),
  hex: document.getElementById("hex"),
  numKey: document.getElementById("numKey"),
  planet: document.getElementById("planet"),
  notes: document.getElementById("notes"),
  stage: document.getElementById("stage"),
  startTone: document.getElementById("startTone"),
  stopTone: document.getElementById("stopTone"),
  renderBtn: document.getElementById("renderBtn"),
  saveBtn: document.getElementById("saveBtn"),
  exportBtn: document.getElementById("exportBtn")
};

const keyLS = "stone-grimoire:living-sculpture-fusion";

/* ---------- Gentle helpers ---------- */
async function tryImport(urls){
  for(const u of urls){
    try{ return await import(u); }catch(e){}
  }
  return null;
}
async function loadJSON(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) return null;
    return await r.json();
  }catch(e){ return null; }
}
function lerp(a,b,t){ return a+(b-a)*t; }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function prefersReducedMotion(){ return window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches; }

/* ---------- Boot: load data, engines, and saved state ---------- */
(async function boot(){
  // Engines (best-effort)
  state.engines.helper    = await tryImport(["../helpers/cathedral-helper.js"]);
  state.engines.fractal   = await tryImport(["../assets/js/engines/fractal-engine.js", "../assets/js/engines/cymatic-engine.js"]);
  state.engines.planetary = await tryImport(["../assets/js/planetary-light.js", "../assets/js/engines/planetary-hours.js"]);

  // Data
  const angels = await loadJSON("../assets/data/angels72.json");
  if(angels && Array.isArray(angels)){
    state.angels = angels;
    els.angelA.innerHTML = '<option value="">-- select --</option>' + angels.map((a,i)=>`<option value="${i}">#${String(i+1).padStart(2,"0")} -- ${a.name||("Shem "+(i+1))}</option>`).join("");
    els.angelB.innerHTML = '<option value="">(none)</option>' + angels.map((a,i)=>`<option value="${i}">#${String(i+1).padStart(2,"0")} -- ${a.name||("Shem "+(i+1))}</option>`).join("");
  }else{
    els.angelA.innerHTML = '<option value="">(angels72.json missing)</option>';
    els.angelB.innerHTML = '<option value="">(angels72.json missing)</option>';
  }

  const packs = await loadJSON("../assets/data/stylepacks.json");
  if(packs && typeof packs==="object"){
    state.stylepacks = packs;
    const opts = Object.keys(packs).sort().map(k=>`<option value="${k}">${k}</option>`).join("");
    els.stylepack.innerHTML = '<option value="">-- select --</option>'+opts;
  }else{
    els.stylepack.innerHTML = '<option value="">(stylepacks.json missing)</option>';
  }

  // Load saved session
  try{
    const raw = localStorage.getItem(keyLS);
    if(raw){
      const s = JSON.parse(raw);
      ["angelA","angelB","stylepack","hex","numKey","planet","notes"].forEach(k=>{
        if(s[k]!=null && els[k]) els[k].value = s[k];
      });
    }
  }catch(e){}

  // Wire UI
  document.querySelectorAll("[data-tint]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const t = b.getAttribute("data-tint");
      document.body.className = "";
      document.body.classList.add("t-"+t);
    });
  });

  els.renderBtn.addEventListener("click", render);
  els.saveBtn.addEventListener("click", saveLocal);
  els.exportBtn.addEventListener("click", exportJSON);
  els.startTone.addEventListener("click", startTone);
  els.stopTone.addEventListener("click", stopTone);

  // First render
  render();
})();

/* ---------- Core: render the living sculpture ---------- */
function currentConfig(){
  const idxA = parseInt(els.angelA.value,10); const A = isFinite(idxA)? state.angels[idxA] : null;
  const idxB = parseInt(els.angelB.value,10); const B = isFinite(idxB)? state.angels[idxB] : null;
  const pack = state.stylepacks[els.stylepack.value] || null;
  const hex  = clamp(parseInt(els.hex.value,10)||0, 0, 64);
  const key  = els.numKey.value || "";
  const planet = (els.planet.value||"Moon").toLowerCase();
  const notes = els.notes.value||"";

  // Derive tone (Hz) in a sponsor-safe way (no autoplay): base + deltas
  // Base mapping: planet → starting Hz
  const baseHzMap = { moon:210.42, venus: 221.23, sun: 256.00, mercury: 176.00, jupiter:320.00, mars: 182.00, saturn: 144.00 };
  let hz = baseHzMap[planet] || 210.42;

  // Add small mod from hexagram and numerology (gentle ±n)
  if(hex>0){ hz += (hex%6 - 3) * 1.25; }
  if(key){ const n = parseInt(key,10); if(isFinite(n)) hz += (n%9 - 4) * 0.9; }

  // Color swatch from stylepack (fallback)
  const sw = (pack && pack.palette) ? pack.palette : { ink:"#1b1b1b", wash:"#f7f1e3", accent:"#2f5a9e", gold:"#d4af37" };

  return { A, B, packName: els.stylepack.value, sw, hex, key, planet, hz, notes };
}

function render(){
  const cfg = currentConfig();
  const c = els.stage; const ctx = c.getContext("2d");
  const W = c.width, H = c.height;

  // Clear with wash
  ctx.fillStyle = cfg.sw.wash || "#ffffff";
  ctx.fillRect(0,0,W,H);

  // Sacred backplate: concentric aeons (Gonzalez-like glaze layers)
  const cx = W*0.5, cy = H*0.5;
  const rings = prefersReducedMotion()? 8 : 16;
  for(let i=0;i<rings;i++){
    const r = lerp(40, Math.min(W,H)*0.46, i/(rings-1));
    const g = ctx.createRadialGradient(cx,cy, r*0.15, cx,cy, r);
    g.addColorStop(0, hexBlend(cfg.sw.accent||"#2f5a9e", "#ffffff", 0.78));
    g.addColorStop(1, hexBlend(cfg.sw.ink||"#1b1b1b", cfg.sw.wash||"#f7f1e3", 0.82));
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();
  }

  // Ladder (Jacob) overlay as living spine
  drawLadder(ctx, cx, cy, Math.min(W,H)*0.38, cfg);

  // Vesica/Rose if Venus pack or chosen planet suggests it
  if(cfg.planet==="venus" || (cfg.packName||"").toLowerCase().includes("angelic")){
    drawRose(ctx, cx, cy, Math.min(W,H)*0.22, cfg);
  }

  // Hexagram lattice (binary lines as subtle striations)
  if(cfg.hex>0){ drawHexLines(ctx, cx, cy, Math.min(W,H)*0.30, cfg.hex, cfg); }

  // Archetype sigils (abstract) from A/B initials or indices
  drawSigilPair(ctx, cx, cy, cfg);

  // Border and caption
  ctx.strokeStyle = cfg.sw.gold || "#d4af37"; ctx.lineWidth = 2;
  ctx.strokeRect(10,10,W-20,H-20);

  // Caption (non-intrusive)
  ctx.fillStyle = cfg.sw.ink || "#1b1b1b";
  ctx.font = "14px Georgia, serif";
  const label = [
    cfg.A? ("A: #"+pad((state.angels.indexOf(cfg.A)+1))+" "+(cfg.A.name||"")) : "A: --",
    cfg.B? ("B: #"+pad((state.angels.indexOf(cfg.B)+1))+" "+(cfg.B.name||"")) : "B: --",
    cfg.packName? ("Skin: "+cfg.packName) : "Skin: --",
    cfg.hex? ("Hex: "+cfg.hex) : "Hex: --",
    cfg.key? ("Key: "+cfg.key) : "Key: --",
    "Hz: "+cfg.hz.toFixed(2)
  ].join("   •   ");
  ctx.fillText(label, 24, H-18);

  // If a house fractal/cymatic engine is available, offer a gentle pass
  if(state.engines.fractal && state.engines.fractal.renderTo){
    try{
      state.engines.fractal.renderTo(ctx, {cx, cy, radius: Math.min(W,H)*0.28, hueSeed: cfg.hz, softness: 0.35});
    }catch(e){}
  }
}

/* ---------- Drawing utilities ---------- */
function drawLadder(ctx, cx, cy, r, cfg){
  ctx.save();
  ctx.strokeStyle = hexBlend(cfg.sw.accent||"#2f5a9e", "#000000", 0.35);
  ctx.lineWidth = 1.5;
  const steps = 33; // vertebrae resonance
  const phi = Math.PI*2/steps;
  for(let i=0;i<steps;i++){
    const t = i*phi;
    const x1 = cx + Math.cos(t)*r*0.85;
    const y1 = cy + Math.sin(t)*r*0.85;
    const x2 = cx + Math.cos(t+phi*0.45)*r*0.55;
    const y2 = cy + Math.sin(t+phi*0.45)*r*0.55;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  }
  // Spine
  ctx.lineWidth = 2.2;
  ctx.beginPath(); ctx.ellipse(cx,cy, r*0.12, r*0.86, 0, 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}
function drawRose(ctx, cx, cy, r, cfg){
  ctx.save();
  const petals = 8;
  ctx.strokeStyle = hexBlend(cfg.sw.gold||"#d4af37", cfg.sw.accent||"#2f5a9e", 0.4);
  ctx.lineWidth = 1.4;
  for(let i=0;i<petals;i++){
    const a = i*(Math.PI*2/petals);
    ctx.beginPath();
    ctx.ellipse(cx,cy, r, r*0.45, a, 0, Math.PI*2);
    ctx.stroke();
  }
  // Vesica
  ctx.beginPath(); ctx.ellipse(cx-r*0.5,cy, r*0.9, r*0.45, 0, 0, Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.ellipse(cx+r*0.5,cy, r*0.9, r*0.45, 0, 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}
function drawHexLines(ctx, cx, cy, r, hex, cfg){
  // 6 lines, bottom-up; yin=broken, yang=solid. Map to subtle arcs
  const lines = hexToLines(hex);
  ctx.save(); ctx.strokeStyle = hexBlend(cfg.sw.ink||"#1b1b1b", cfg.sw.wash||"#ffffff", 0.4); ctx.lineWidth = 3;
  for(let i=0;i<6;i++){
    const y = cy + r*0.65 - i*(r*0.22);
    if(lines[i]===1){
      // yang solid
      line(ctx, cx-r*0.7, y, cx+r*0.7, y);
    }else{
      // yin broken
      line(ctx, cx-r*0.7, y, cx-r*0.15, y);
      line(ctx, cx+r*0.15, y, cx+r*0.7, y);
    }
  }
  ctx.restore();
}
function drawSigilPair(ctx, cx, cy, cfg){
  const a = cfg.A? sigilSeed(cfg.A.name||"A", cfg) : null;
  const b = cfg.B? sigilSeed(cfg.B.name||"B", cfg) : null;
  if(a){ drawSigil(ctx, cx, cy, Math.min(ctx.canvas.width,ctx.canvas.height)*0.19, a, cfg, 0.85); }
  if(b){ drawSigil(ctx, cx, cy, Math.min(ctx.canvas.width,ctx.canvas.height)*0.14, b, cfg, 0.65); }
}
function drawSigil(ctx, cx, cy, r, seed, cfg, alpha){
  ctx.save();
  ctx.globalAlpha = alpha||0.8;
  ctx.strokeStyle = cfg.sw.accent||"#2f5a9e";
  ctx.lineWidth = 1.6;
  const pts = 9;
  ctx.beginPath();
  for(let i=0;i<=pts;i++){
    const t = i/pts;
    const th = t*Math.PI*2 + seed.spin;
    const rr = r*(0.65 + 0.35*Math.sin(t*seed.k + seed.jitter));
    const x = cx + Math.cos(th)*rr;
    const y = cy + Math.sin(th)*rr;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();
}
function line(ctx,x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
function pad(n){ return String(n).padStart(2,"0"); }
function hexToLines(h){
  // Return array of 6 (bottom→top), 1=yang, 0=yin
  const n = clamp(parseInt(h,10)||0,1,64)-1;
  const arr = [];
  for(let i=0;i<6;i++){ arr.push((n>>i)&1); }
  return arr;
}
function hexBlend(a,b,t){
  // simple hex blend #rrggbb
  function toRGB(h){ const x=parseInt(h.replace("#",""),16); return {r:(x>>16)&255,g:(x>>8)&255,b:x&255}; }
  function toHex(o){ const n=(o.r<<16)|(o.g<<8)|o.b; return "#"+("000000"+n.toString(16)).slice(-6); }
  const A=toRGB(a), B=toRGB(b);
  return toHex({ r:Math.round(lerp(A.r,B.r,t)), g:Math.round(lerp(A.g,B.g,t)), b:Math.round(lerp(A.b,B.b,t))});
}
function sigilSeed(name, cfg){
  const sum = (name||"").split("").reduce((s,ch)=>s+ch.charCodeAt(0),0);
  const k = 3 + (sum % 5);           // lobes
  const jitter = ((sum%37)/37)*1.7;  // wobble
  const spin = (sum%360) * (Math.PI/180);
  return {k, jitter, spin};
}

/* ---------- Audio (ND-safe manual start/stop) ---------- */
async function startTone(){
  if(state.audio.ctx) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const cfg = currentConfig();
  osc.type = "sine";
  osc.frequency.value = cfg.hz;       // derived gentle Hz
  gain.gain.value = 0.035;            // soft by default
  osc.connect(gain).connect(ctx.destination);
  try{ osc.start(); }catch(e){}
  state.audio = { ctx, osc, gain };
  els.startTone.disabled = true; els.stopTone.disabled = false;
}
async function stopTone(){
  const a = state.audio;
  if(!a || !a.ctx) return;
  try{ a.osc.stop(); }catch(e){}
  try{ await a.ctx.close(); }catch(e){}
  state.audio = { ctx:null,osc:null,gain:null };
  els.startTone.disabled = false; els.stopTone.disabled = true;
}

/* ---------- Save / Export ---------- */
function saveLocal(){
  const cfg = currentConfig();
  localStorage.setItem(keyLS, JSON.stringify({
    angelA: els.angelA.value,
    angelB: els.angelB.value,
    stylepack: els.stylepack.value,
    hex: els.hex.value,
    numKey: els.numKey.value,
    planet: els.planet.value,
    notes: els.notes.value,
    hz: cfg.hz
  }));
  alert("Saved on this device.");
}
function exportJSON(){
  const cfg = currentConfig();
  const payload = {
    room: "living-sculpture-fusion",
    when: new Date().toISOString(),
    selection: {
      angelA: cfg.A? {index: state.angels.indexOf(cfg.A), name: cfg.A.name||null} : null,
      angelB: cfg.B? {index: state.angels.indexOf(cfg.B), name: cfg.B.name||null} : null,
      stylepack: cfg.packName||null,
      hexagram: cfg.hex||null,
      numerologyKey: cfg.key||null,
      planet: cfg.planet||null
    },
    derived: { hz: cfg.hz },
    notes: cfg.notes
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "living-sculpture-fusion.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>