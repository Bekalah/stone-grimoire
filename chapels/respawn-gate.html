<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Respawn Gate -- Codex 144:99</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta
    name="description"
    content="The Fool’s Threshold: step through, set intention, and re-enter the living cathedral with tone and light."
  >

  <!-- Site styles (same stack as cathedral) -->
  <link rel="stylesheet" href="../assets/css/palette.css">
  <link rel="stylesheet" href="../assets/css/light.css">
  <script src="../assets/js/theme.js" defer></script>
  <script src="../assets/js/planetary-light.js" defer></script>

  <!-- Rebecca (velvet-noir architect-scribe) -->
  <link rel="stylesheet" href="../assets/css/rebecca.css">

  <style>
    /* Page ornament -- quiet temple card */
    :root{ --gate-bg:#f8f2e6; --gate-edge:#e7dbc6; }
    body.mystic{
      margin:0; color:var(--ink);
      font:18px/1.62 Georgia,"Iowan Old Style",serif;
      background:radial-gradient(circle at 50% 18%, var(--bg) 78%, #ece7dc 100%);
    }
    header, footer{
      margin:18px auto; max-width:1100px; text-align:center;
      background:var(--wash); border:1px solid var(--line); border-radius:12px; padding:14px 18px;
    }
    header h1{ margin:.2rem 0 .3rem; color:var(--accent) }
    .wrap{ max-width:1100px; margin:0 auto; padding:12px 14px 28px }
    .gate{
      position:relative; background:#fcf6e9; border:1px solid var(--gate-edge); border-radius:14px;
      padding:24px; box-shadow:0 0 0 4px rgba(255,255,255,.6) inset, 0 1px 18px rgba(0,0,0,.05);
      display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;
    }
    @media (max-width:900px){ .gate{ grid-template-columns:1fr } }

    .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px }
    h2{ color:var(--accent-2); margin:.4rem 0 .6rem; font-size:1.15rem }
    .action{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:.6rem 0 0 }
    .btn{
      appearance:none; border:1px solid var(--accent-2); color:#fff; background:var(--accent-2);
      padding:.6rem .9rem; border-radius:10px; font:600 16px/1.1 ui-sans-serif,system-ui;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
      cursor:pointer;
    }
    .btn.alt{
      background:#fff; color:var(--accent-2);
    }
    .hint{ color:#6b6257; font-size:.93rem; margin:.25rem 0 0 }
    .plaque{
      font-size:.92rem; color:#6b6257; background:#fff; border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; margin-top:10px
    }

    /* Optional cymatics canvas */
    .vis{
      min-height:260px; background:#fff; border:1px dashed var(--line); border-radius:12px;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    #cymatics{ width:100%; height:100%; display:block }
    .meta-line{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap }
    a{ color:var(--accent); text-decoration:none } a:hover{text-decoration:underline}
  </style>
</head>

<body class="mystic" data-theme="netzach">
  <header>
    <div class="meta-line">
      <div><a href="../cathedral.html">⟵ Back to Cathedral</a></div>
      <div>Open-world · No locks · ND-safe audio</div>
      <div><a href="../angels72.html">Shem Ladder (72)</a></div>
    </div>
    <h1>Respawn Gate</h1>
    <p class="hint">The Fool’s Threshold -- step across with intention; tone and light will accompany you.</p>
  </header>

  <div class="wrap">
    <section class="gate" aria-label="Respawn Gate">
      <!-- Left: ritual card -->
      <article class="panel" aria-labelledby="rite">
        <h2 id="rite">Rite of Re-Entry</h2>
        <p>Stand at the Gate. Name the direction of your will in a single breath. Press the seal to begin, and the Cathedral will tune itself to your step.</p>

        <div class="action">
          <button id="begin" class="btn" type="button">✦ Step Through</button>
          <button id="quiet" class="btn alt" type="button" aria-pressed="false">Quietus (mute)</button>
        </div>
        <p class="hint">Audio never autoplays; first tap only. Volume is gentle and capped.</p>

        <aside class="plaque" role="note" aria-label="Curator Plaque">
          <strong>Plaque -- Provenance</strong><br>
          Intention: Fool’s threshold for will, safety, and reset.<br>
          Technique: Tone bloom at 528 Hz (default), ND-safe chain; Rebecca ledger logging.<br>
          Lineage: Tarot 0; Initiation by choice; reciprocity over hierarchy.<br>
          Evidence: Local ledger export (JSON) via Rebecca panel.
        </aside>
      </article>

      <!-- Right: visual well (cymatics if present) -->
      <aside class="panel vis" aria-label="Resonance Well">
        <canvas id="cymatics" aria-hidden="true"></canvas>
      </aside>
    </section>
  </div>

  <footer>
    ❦ Green Man’s vine entwines; the Choir resounds. ❦<br>
    93 93/93 -- Stone Grimoire · Rosslyn Pattern
  </footer>

  <!-- Logic -->
  <script type="module">
    import { initRebecca, rebeccaSpeak, rebeccaLog, rebeccaMute } from "../assets/js/components/rebecca.js";
    // Optional audio & visuals (will no-op gracefully if files missing)
    import { ensureAudio, setToneHz, stopTone } from "../assets/js/engines/ambient-engine.js";
    import { mountCymaticsCanvas } from "../assets/js/engines/cymatic-engine.js";

    // 0) Bring in Rebecca everywhere (open-world, no locks)
    initRebecca({});

    // 1) Dispatch a 'respawn' moment (Rebecca listens and logs)
    function announceRespawn(detail){
      document.dispatchEvent(new CustomEvent("codex:respawn", { detail }));
      // Also log explicitly for redundancy
      rebeccaLog({ type:"respawn", ...detail });
    }

    // 2) Safe entry: only on user gesture
    async function stepThrough(){
      // Narrate in the Rebecca aside
      rebeccaSpeak("respawn");

      // Start audio chain and set gentle default tone (528 Hz)
      try{
        await ensureAudio();
        setToneHz(528);

        // Broadcast tone to other systems / logs
        document.dispatchEvent(new CustomEvent("codex:tone", { detail:{ hz:528, origin:"respawn-gate" }}));
        rebeccaLog({ type:"tone", hz:528, origin:"respawn-gate" });
      }catch(_){ /* audio is optional; remain silent if blocked */ }

      // Announce the rite for ledgers / sponsors
      announceRespawn({ gate:"fool", note:"stepped-through", when: Date.now() });

      // Cymatics (if engine exists)
      try { mountCymaticsCanvas("#cymatics"); } catch(_){ /* optional */ }

      // Subtle visual flicker (accessibility-safe)
      const body = document.body;
      body.style.transition = "background-color .6s ease";
      body.style.backgroundColor = "rgba(244, 231, 198, .35)";
      setTimeout(()=> body.style.backgroundColor = "", 650);
    }

    // 3) Quietus toggle
    let isQuiet = false;
    function toggleQuiet(){
      isQuiet = !isQuiet;
      const btn = document.getElementById("quiet");
      btn.setAttribute("aria-pressed", String(isQuiet));
      if(isQuiet){ stopTone(); rebeccaMute(true); }
      else { setToneHz(528); rebeccaMute(false); }
    }

    // Wire UI
    window.addEventListener("DOMContentLoaded", () => {
      const begin = document.getElementById("begin");
      const quiet = document.getElementById("quiet");
      begin.addEventListener("click", stepThrough);
      quiet.addEventListener("click", toggleQuiet);
    });
  </script>
</body>
</html>