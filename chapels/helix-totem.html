<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Helix Totem -- Jacob's Ladder (72)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="A helical Jacob's Ladder with 72 angelic steps; touch a step to shift tone, style, and cymatic bloom.">
  <!-- House styles -->
  <link rel="stylesheet" href="../assets/css/palette.css">
  <link rel="stylesheet" href="../assets/css/light.css">
  <link rel="stylesheet" href="../assets/css/folio.css">
  <style>
    body.mystic{ background: radial-gradient(circle at 50% 18%, var(--wash) 78%, #ece7dc 100%); color: var(--ink); }

    header, footer{
      margin:18px auto; max-width:1000px; text-align:center;
      background:var(--wash); border:1px solid var(--line); border-radius:12px; padding:14px 18px;
      box-shadow: 0 1px 0 #fff inset, 0 0 0 3px rgba(212,175,55,.08) inset;
    }
    header h1{ margin:.2rem 0 .3rem; color:var(--accent) }

    .wrap{ max-width:1100px; margin:0 auto; padding:10px 12px 24px }

    /* Stage */
    .stage{
      position:relative; overflow:hidden;
      border:1px solid var(--line); border-radius:14px; background:#fff;
      min-height:540px; box-shadow: var(--shadow);
    }
    .helix{
      position:relative; height:540px; perspective:1100px; background:linear-gradient(#ffffff, #fbf8f0);
    }
    .spindle{
      position:absolute; inset:0; transform-style:preserve-3d;
      animation: spin 40s linear infinite;
    }
    @keyframes spin{
      from{ transform: rotateY(0deg); }
      to{   transform: rotateY(360deg); }
    }
    @media (prefers-reduced-motion: reduce){
      .spindle{ animation:none }
    }

    .step{
      --r: 220px; /* helix radius */
      position:absolute; top:50%; left:50%;
      width:220px; transform-style:preserve-3d; will-change:transform,opacity;
      text-align:left;
    }
    .step button{
      display:block; width:100%;
      background:#ffffffcc; backdrop-filter: blur(1px);
      border:1px solid var(--line); border-radius:10px; padding:8px 10px;
      font: 15px/1.35 Georgia, "Iowan Old Style", serif; color:var(--ink);
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .step .meta{ display:block; font-size:.82rem; color:#6b6257; margin-top:2px }
    .step[aria-current="true"] button{ border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(212,175,55,.25) }

    .panel{
      padding:14px; background:#fff; border:1px solid var(--line);
      border-radius:12px; margin-top:10px;
    }

    /* Cymatics canvas sits behind the helix as aureole */
    .cymatic-wrap{
      position:absolute; inset:0; pointer-events:none; opacity:.55;
    }
    #cymatics{ width:100%; height:100% }

    /* Controls */
    .controls{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0;
    }
    .controls label{ display:inline-flex; align-items:center; gap:6px; font-size:.95rem; }
    .controls input[type="checkbox"]{ transform: translateY(1px) }

    /* Footer nav */
    .site-footer{margin:2rem auto;max-width:1000px;padding:12px;
      background:var(--wash);border-top:2px solid var(--accent-2);text-align:center}
    .site-footer ul{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .site-footer a{color:var(--accent);text-decoration:none;font-size:.95rem}
    .site-footer a:hover{text-decoration:underline}
    .site-footer .seal{margin-top:.8rem;color:var(--accent-2)}
  </style>
</head>
<body class="mystic" data-theme="yesod">
<header>
  <h1>Helix Totem -- Jacob's Ladder</h1>
  <p class="small">72 angelic steps woven as a pillar. Tap a step to shift style, tone, and bloom. ND-safe: no autoplay.</p>
</header>

<div class="wrap">
  <div class="controls" role="group" aria-label="View and audio">
    <label><input id="toggle-motion" type="checkbox" checked> Reduced Motion</label>
    <label><input id="toggle-mute" type="checkbox"> Mute</label>
  </div>

  <section class="stage" aria-label="Helix Totem">
    <div class="cymatic-wrap"><canvas id="cymatics" aria-hidden="true"></canvas></div>
    <div class="helix">
      <div id="spindle" class="spindle" aria-live="polite"></div>
    </div>
  </section>

  <aside class="panel plaque" role="note" aria-label="Curator Plaque" id="plaque">
    <strong>Plaque -- Provenance</strong><br>
    Intention: Climb the Ladder by resonance (tone, color, form).<br>
    Technique: angels72.json â†’ stylepack + toneHz â†’ cymatic bloom; helix layout with CSS 3D; ND-safe audio.<br>
    Lineage: Shem ha-Mephorash (72), Hermetic Qabalah, Dee/Enochian, Agrippan correspondences.<br>
    Evidence: assets/data/angels72.json Â· assets/data/stylepacks.json.<br>
    Reflection: Each step is an archetype lens; selection updates aura without forcing sound.
  </aside>
</div>

<footer class="site-footer" role="contentinfo">
  <nav aria-label="Site links">
    <ul>
      <li><a href="../index.html">âœ¦ Frontispiece (Door)</a></li>
      <li><a href="../cathedral.html">âœ¦ Cathedral Nave</a></li>
      <li><a href="./apprentice-pillar.html">Apprentice Pillar</a></li>
      <li><a href="./crypt.html">Crypt</a></li>
      <li><a href="./lady-chapel.html">Lady Chapel</a></li>
      <li><a href="./crystal-grid.html">Crystal Grid</a></li>
      <li><a href="./musical-cubes.html">Musical Cubes</a></li>
      <li><a href="./cubes-visual-lab.html">Cubes Visual Lab</a></li>
      <li><a href="./helix-totem.html">Jacob's Ladder</a></li>
      <li><a href="./shem-ladder.html">Shem Ladder (72)</a></li>
      <li><a href="../main/Thelemic-Alignment-Brief.html">Thelemic Alignment</a></li>
      <li><a href="../main/05_ateliers/manifesto.html">Ateliers Manifesto</a></li>
    </ul>
  </nav>
  <p class="seal">ð“‚€ âœ¦ Codex 144:99 âœ¦ ð“‚€</p>
</footer>

<script type="module">
  import { setToneHz, onToneChange, setMuted, getAnalyser } from "../assets/js/ambient-engine.js";
  import { mountCymaticsCanvas } from "../assets/js/engines/cymatic-engine.js";

  // iPad-safe motion + mute toggles
  const root = document.documentElement;
  const motion = document.getElementById("toggle-motion");
  const mute = document.getElementById("toggle-mute");
  const applyMotion = () => root.classList.toggle("reduced-motion", motion.checked);
  motion.addEventListener("change", applyMotion); applyMotion();
  mute.addEventListener("change", () => setMuted(!!mute.checked));

  // Cymatic bloom (behind the helix)
  const cym = document.getElementById("cymatics");
  mountCymaticsCanvas(cym, { analyser: getAnalyser(), petals: 24, aureole: true });

  // Build the helix from angels72.json
  const spindle = document.getElementById("spindle");
  const plaque = document.getElementById("plaque");

  const dataUrl = "../assets/data/angels72.json";
  const packsUrl = "../assets/data/stylepacks.json";

  const stylepackApply = (id) => {
    // lightweight apply: expose chosen pack id to CSS and engines
    document.documentElement.setAttribute("data-stylepack", id);
    // if your cathedral engine exposes a function like applyStylepack(id), you can call it here
    // window.applyStylepack && window.applyStylepack(id);
  };

  function updatePlaque(a){
    plaque.innerHTML =
      "<strong>Plaque -- Jacob's Ladder</strong><br>" +
      "Angel: <b>" + (a.name || a.id) + "</b> Â· Sign/Decan: " + (a.sign || "?") + " " + (a.decan || "") + "<br>" +
      "Tone: " + (a.toneHz || "--") + " Hz Â· Style: " + (a.stylepack || "--") + "<br>" +
      "Soyga: " + (a.soyga || "--") + " Â· Number: " + (a.num || "--");
  }

  function makeStep(a, i, total){
    const el = document.createElement("div");
    el.className = "step";
    const theta = (i / total) * Math.PI * 2 * 3;     // 3 full turns
    const y = -240 + (i * (480 / total));            // distribute vertically
    const x = Math.cos(theta) * 220;
    const z = Math.sin(theta) * 220;
    el.style.transform =
      "translate3d(" + x + "px," + y + "px," + z + "px) rotateY(" + (theta * 180/Math.PI) + "deg)";

    const btn = document.createElement("button");
    btn.setAttribute("type", "button");
    btn.innerHTML =
      (String(i+1).padStart(2,"0")) + ". " + (a.name || a.id || "Angel") +
      "<span class=\"meta\">" +
      (a.sign || "") + (a.decan?(" " + a.decan):"") + " Â· " +
      (a.toneHz? (a.toneHz + " Hz"):"") +
      "</span>";
    btn.addEventListener("click", () => {
      // Focus this step
      document.querySelectorAll(".step[aria-current='true']").forEach(s => s.removeAttribute("aria-current"));
      el.setAttribute("aria-current","true");

      // Apply visual skin and tone
      if (a.stylepack) stylepackApply(a.stylepack);
      if (!mute.checked && a.toneHz) setToneHz(a.toneHz);

      // Update plaque
      updatePlaque(a);
    });

    el.appendChild(btn);
    return el;
  }

  async function boot(){
    // Warm audio with a user gesture: first tap anywhere will start the context inside ambient-engine
    window.addEventListener("touchstart", () => setToneHz(0), { once:true });
    window.addEventListener("mousedown", () => setToneHz(0), { once:true });

    const [angelsRes, packsRes] = await Promise.all([fetch(dataUrl), fetch(packsUrl)]);
    const angels = await angelsRes.json();
    await packsRes.json(); // not used directly here but ensures file is present

    spindle.innerHTML = "";
    angels.forEach((a, i) => spindle.appendChild(makeStep(a, i, angels.length)));

    // Select a friendly default (Moonchild or first)
    const defaultIndex = angels.findIndex(a => (a.id||"").toLowerCase().includes("moonchild"));
    const pick = angels[defaultIndex >= 0 ? defaultIndex : 0];
    if (pick){
      const firstBtn = spindle.querySelectorAll(".step button")[defaultIndex >=0 ? defaultIndex : 0];
      firstBtn && firstBtn.click();
    }
  }

  boot();
</script>
</body>
</html>