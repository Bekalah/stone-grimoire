<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>The Living Cathedral</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="The Living Cathedral -- Codex 144:99">
  <meta property="og:description" content="A breathing, visionary cathedral -- tone, bloom, and living sculpture.">
  <meta name="twitter:card" content="summary_large_image">
  <style>
    :root{ --bg:#0b0d10; --fg:#eae6d7; --wash:#0b0d10; --accent:rgba(47,90,158,0.35); --accent-2:rgba(212,175,55,0.40); }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .stack{position:relative;width:100%;height:auto}
    .stack canvas{display:block;width:100%;height:auto;pointer-events:none}
    #cath-halo{max-height:52vh}
    #cath-relief{margin-top:-52vh;max-height:52vh;mix-blend-mode:screen}
    .panel{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,input[type=range],button{background:#141a21;color:var(--fg);border:1px solid #22303f;border-radius:8px;padding:8px 10px;cursor:pointer}
    .room{margin-top:18px;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;opacity:.9}
    @media (max-width:480px){#cath-halo,#cath-relief{max-height:50vh}}
  </style>
</head>
<body>
  <main class="wrap">

    <header>
      <h1 style="margin:0;font:600 18px system-ui">The Living Cathedral</h1>
      <nav><!-- your links --></nav>
    </header>

    <section class="stack" aria-label="Cathedral Visuals">
      <canvas id="cath-halo" aria-hidden="true"></canvas>
      <canvas id="cath-relief" aria-hidden="true"></canvas>
    </section>

    <section class="panel" aria-label="Controls">
      <label for="style">Stylepack</label>
      <select id="style">
        <option value="">(no change)</option>
        <option value="rosslyn-gothic">Rosslyn Gothic</option>
        <option value="hilma-spiral">Hilma Spiral</option>
        <option value="rosicrucian-black">Rosicrucian Black</option>
      </select>

      <label for="vol">Volume</label>
      <input id="vol" type="range" min="0" max="0.12" step="0.01" value="0.04">

      <label for="alpha">Relief Alpha</label>
      <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.26">

      <span style="flex:1"></span>
      <button id="btnSave">Save Plate (PNG)</button>
      <button id="btnShare">Share Link</button>
      <button id="btnClip">Record 6s Clip</button>
    </section>

    <section class="room" id="room-info">
      <strong>Realm:</strong> Nave • <strong>Tone:</strong> 432 Hz • <strong>Overlay:</strong> stone-angels.png
    </section>

  </main>

  <script type="module">
    import { ensureAudio, onToneChange, setToneHz, setVolume } from "./assets/js/engines/ambient-engine.js";
    import { mountCymaticsCanvas } from "./assets/js/engines/cymatic-engine.js";
    import { mountOverlayCanvas } from "./assets/js/effects/overlay-relief.js";
    import { applyStylepack } from "./assets/js/effects/stylepack-apply.js";
    import { ensureFusionMaps, resolveFusion } from "./assets/js/engines/fusion-router.js";
    import { exportCompositePNG, shareURL, recordCompositeWebM } from "./assets/js/utils/share-export.js";

    await ensureFusionMaps();

    const haloAPI = await mountCymaticsCanvas("#cath-halo");
    const reliefAPI = await mountOverlayCanvas("#cath-relief", { src:"assets/overlays/stone-angels.png", alpha:0.26, useAudio:true });

    try { await ensureAudio(); } catch(_) {}

    document.getElementById("style")?.addEventListener("change", (e)=>{ const v=e.target.value||""; if (v) applyStylepack(v); }, { passive:true });
    document.getElementById("vol")?.addEventListener("input", (e)=> setVolume(e.target.value), { passive:true });
    document.getElementById("alpha")?.addEventListener("input", (e)=>{
      reliefAPI?.unmount?.();
      mountOverlayCanvas("#cath-relief", { src:"assets/overlays/stone-angels.png", alpha:Number(e.target.value), useAudio:true });
    }, { passive:true });

    // If you navigate by zodiac/decan or pillar:
    // resolveFusion({ zodiac:"Aries", decan:2 });  // example
    // resolveFusion({ pillar:"Apprentice" });

    onToneChange((payload)=>{
      const hz = typeof payload === "number" ? payload : (payload && payload.hz) || 0;
      if (!hz) return;
      const el = document.getElementById("room-info");
      if (el) el.innerHTML = "<strong>Realm:</strong> Nave • <strong>Tone:</strong> " + hz + " Hz • <strong>Overlay:</strong> stone-angels.png";
    });

    setTimeout(()=> setToneHz(432, { name:"Nave", element:"Aether", stylepack:"rosslyn-gothic" }), 600);

    document.getElementById("btnSave")?.addEventListener("click", ()=> {
      exportCompositePNG({ halo:"#cath-halo", relief:"#cath-relief", width:2160, height:1215, caption: document.getElementById("room-info")?.innerText || "Living Cathedral", subcaption:"Cathedral of Circuits • Codex 144:99" });
    });
    document.getElementById("btnShare")?.addEventListener("click", ()=> {
      const info=document.getElementById("room-info")?.innerText||""; const m=info.match(/Tone:\s*(\d+)\s*Hz/i); const hz=m?m[1]:432;
      shareURL({ hz, room:"nave", alpha: Number(document.getElementById("alpha")?.value || 0.26) });
    });
    document.getElementById("btnClip")?.addEventListener("click", async ()=> {
      try { await recordCompositeWebM("#cath-halo", "#cath-relief", 6, 30); } catch(e){ alert("Recording not supported: "+e.message); }
    });
  </script>
  
  <!-- Planetary Hour (opt-in, ND-safe). Adds a gentle tint once/hour.
     This DOES NOTHING unless body[data-hourly="on"] is present. Safe to keep in place. -->
<script>
  // feature flag: remove or toggle this attribute whenever you want
  document.body.setAttribute('data-hourly','on');
</script>

<script>
(function(){
  // no-op unless opted in
  if (document.body.getAttribute('data-hourly') !== 'on') return;

  // Chaldean order + weekday rulers
  var ORDER    = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
  var DAYRULE  = {0:"Sun",1:"Moon",2:"Mars",3:"Mercury",4:"Jupiter",5:"Venus",6:"Saturn"};

  // gentle planet tints (edit to taste). Uses inline CSS vars so it won't collide with your CSS.
  var TINT = {
    Saturn:  "#2f2a38",  // indigo-black
    Jupiter: "#3a2f1a",  // warm umber
    Mars:    "#4a1f1f",  // soft oxblood
    Sun:     "#f6e8b1",  // vellum gold-wash
    Venus:   "#e6d5df",  // rose-violet glaze
    Mercury: "#cad6ef",  // airy blue
    Moon:    "#e9eef2"   // pearl grey
  };

  // apply tint by setting CSS custom properties on <html>
  function applyPlanet(planet){
    var root = document.documentElement;
    var bg   = TINT[planet] || "#f8f5ef";
    // set subtle variables ONLY if they exist, else fall back to body background
    root.style.setProperty('--hour-bg', bg);
    // add very gentle wash layer
    if (!document.getElementById('hour-wash-style')){
      var st = document.createElement('style');
      st.id='hour-wash-style';
      st.textContent = `
        :root { --hour-bg: transparent; --hour-fade: .85s; }
        html, body { transition: background-color var(--hour-fade) ease, color var(--hour-fade) ease; }
        body { background-color: var(--hour-bg); }
      `;
      document.head.appendChild(st);
    }
  }

  // pick planet by "clock mode" (simple, dependency-free)
  function tick(){
    var now = new Date();
    var wd  = now.getDay(); // 0=Sun..6=Sat
    var hr  = now.getHours();
    var start = ORDER.indexOf(DYRUL(wd));
    var idx = ( (hr - 6) + start ) % ORDER.length; // hour ~ seed at 06:00
    if (idx < 0) idx += ORDER.length;
    var planet = ORDER[idx];
    if (planet !== last) { applyPlanet(planet); last = planet; }
  }
  function DYRUL(d){ return DAYRULE[d]; }

  var last = "";
  tick();
  // check once per minute; extremely light
  var timer = setInterval(tick, 60*1000);

  // rollback helper if anything feels off
  window.CodexHours = {
    off: function(){
      clearInterval(timer);
      document.documentElement.style.removeProperty('--hour-bg');
      var s = document.getElementById('hour-wash-style'); if (s) s.remove();
    }
  };
})();
</script>
  
</body>
</html>