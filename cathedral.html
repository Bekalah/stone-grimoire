

  <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stone Grimoire -- Cathedral Nave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="The Living Cathedral -- Codex 144:99">
  <meta property="og:description" content="A breathing, visionary cathedral -- tone, bloom, and living sculpture.">
  <meta name="twitter:card" content="summary_large_image">

  <!-- House styles (keep your variables + light skin) -->
  <link rel="stylesheet" href="/assets/css/palette.css">
  <link rel="stylesheet" href="/assets/css/light.css">
  <link rel="stylesheet" href="/assets/css/perm-style.css" />
  <link rel="stylesheet" href="./assets/css/meta_realms.css">
  <link rel="stylesheet" href="./assets/css/cathedral_icon.css">
<script src="/bridge/c99-bridge.js" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    C99Bridge.ndSafe();
    const tokens = await C99Bridge.loadTokens('/assets/tokens/perm-style.json');
    C99Bridge.applyCSSVars(tokens);
  });
</script>

  <style>
    :root{
      --bg:#0b0d10; --fg:#eae6d7;
      --wash:#0b0d10; --accent:rgba(47,90,158,.35); --accent-2:rgba(212,175,55,.40);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    header h1{margin:0;font:600 18px system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .stack{position:relative;width:100%;height:auto}
    .stack canvas{display:block;width:100%;height:auto;pointer-events:none}
    #cath-halo{max-height:52vh}
    #cath-relief{margin-top:-52vh;max-height:52vh;mix-blend-mode:screen}
    .panel{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,input[type=range],button{
      background:#141a21;color:var(--fg);border:1px solid #22303f;border-radius:8px;padding:8px 10px;cursor:pointer
    }
    .room{margin-top:18px;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;opacity:.9}

    /* footer */
    .site-footer{margin:2rem auto;max-width:1000px;padding:12px;
      background:var(--wash);border-top:2px solid var(--accent-2);text-align:center}
    .site-footer ul{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .site-footer a{color:var(--fg);text-decoration:none;font-size:.95rem;opacity:.9}
    .site-footer a:hover{text-decoration:underline}
    .site-footer .seal{margin-top:.8rem;color:var(--accent-2)}
    @media (max-width:480px){#cath-halo,#cath-relief{max-height:50vh}}
  </style>
</head>
<body>
  <main class="wrap">

    <header>
      <h1>The Living Cathedral</h1>
      <nav aria-label="Quick links">
        <a href="./index.html" style="color:var(--fg);opacity:.8">Frontispiece</a>
        &nbsp;Â·&nbsp;
        <a href="./chapels/cosmogenesis/index.html" style="color:var(--fg);opacity:.8">Cosmogenesis</a>
        &nbsp;Â·&nbsp;
        <a href="./chapels/helix-totem.html" style="color:var(--fg);opacity:.8">Helix Totem</a>
        &nbsp;Â·&nbsp;
        <a href="./angels72.html" style="color:var(--fg);opacity:.8">Angels 72</a>
      </nav>
    </header>

    <section class="stack" aria-label="Cathedral Visuals">
      <canvas id="cath-halo" aria-hidden="true"></canvas>
      <canvas id="cath-relief" aria-hidden="true"></canvas>
    </section>

    <section class="panel" aria-label="Controls">
      <label for="style">Stylepack</label>
      <select id="style">
        <option value="">(no change)</option>
        <option value="rosslyn_gothic">Rosslyn Gothic</option>
        <option value="hilma_spiral">Hilma Spiral</option>
        <option value="rosicrucian_black">Rosicrucian Black</option>
      </select>

      <label for="vol">Volume</label>
      <input id="vol" type="range" min="0" max="0.12" step="0.01" value="0.04" aria-label="Volume">

      <label for="alpha">Relief Alpha</label>
      <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.26" aria-label="Relief opacity">

      <span style="flex:1"></span>
      <button id="btnSave" type="button">Save Plate (PNG)</button>
      <button id="btnShare" type="button">Share Link</button>
      <button id="btnClip" type="button">Record 6s Clip</button>
    </section>

    <section class="room" id="room-info" aria-live="polite">
      <strong>Realm:</strong> Nave â€¢ <strong>Tone:</strong> 432 Hz â€¢ <strong>Overlay:</strong> stone-angels.png
    </section>

    <section id="meta-realms">
      <h2>Meta Realms</h2>
      <ul class="realms-list">
        <li class="realm realm--temple">
          <span class="icon-seal icon-seal--temple" aria-hidden="true"></span>
          <strong>Temple Realm â€” Cathedral of Circuitsâ„¢.</strong>
          Neon stained glass lattices and algorithmic Thrones.
        </li>
        <li class="realm realm--garden">
          <span class="icon-seal icon-seal--garden" aria-hidden="true"></span>
          <strong>Garden Realm â€” Persephone / Regardie.</strong>
          Orchids veined with circuitry and pools of black water.
        </li>
        <li class="realm realm--tavern">
          <span class="icon-seal icon-seal--tavern" aria-hidden="true"></span>
          <strong>Tavern Realm â€” Shadow Academia.</strong>
          Neon sigil lanterns and smoky alcoves of forbidden lore.
        </li>
      </ul>
    </section>

  </main>

  <!-- Main engines + effects (paths corrected to /assets/js/...) -->
  <script type="module">
    // Core audio + events
    import { ensureAudio, onToneChange, setToneHz, setVolume } from "/assets/js/engines/ambient-engine.js";
    // Cymatic halo (ND-safe)
    import { mountCymaticsCanvas } from "/assets/js/engines/cymatic-engine.js";
    // Relief overlay (image responding to audio)
    import { mountOverlayCanvas } from "/assets/js/effects/overlay-relief.js";
    // Style wardrobe helper
    import { applyStylepack } from "/assets/js/effects/stylepack-apply.js";
    // Export / share utils
    import { exportCompositePNG, shareURL, recordCompositeWebM } from "/assets/js/utils/share-export.js";

    // Optional: fusion router (zodiac/decan, pillar, etc.) -- guard if file not present
    let fusion = null;
    try {
      fusion = await import("/assets/js/engines/fusion-router.js");
      if (fusion.ensureFusionMaps) await fusion.ensureFusionMaps();
    } catch (_) {
      // optional module not present -- safe to continue
    }

    // Mount visuals
    const haloAPI   = await mountCymaticsCanvas("#cath-halo");
    const reliefAPI = await mountOverlayCanvas("#cath-relief", {
      src: "/assets/overlays/stone-angels.png",
      alpha: 0.26,
      useAudio: true
    });

    // iPad / iOS: unlock audio on first gesture
    const unlock = async () => { try { await ensureAudio(); } catch(_) {} };
    window.addEventListener("touchstart", unlock, { once:true });
    window.addEventListener("mousedown",  unlock, { once:true });

    // UI wiring
    const sel   = document.getElementById("style");
    const vol   = document.getElementById("vol");
    const alpha = document.getElementById("alpha");

    sel?.addEventListener("change", (e)=>{
      const v = e.target.value || "";
      if (v) applyStylepack(v);
    }, { passive:true });

    vol?.addEventListener("input", (e)=> setVolume(Number(e.target.value)), { passive:true });

    alpha?.addEventListener("input", (e)=>{
      const val = Number(e.target.value);
      reliefAPI?.unmount?.();
      // remount with new alpha
      mountOverlayCanvas("#cath-relief", { src:"/assets/overlays/stone-angels.png", alpha: val, useAudio:true });
    }, { passive:true });

    // Resolve by data (optional)
    // fusion?.resolveFusion?.({ zodiac:"Aries", decan:2 });
    // fusion?.resolveFusion?.({ pillar:"Apprentice" });

    const infoEl = document.getElementById("room-info");
    onToneChange((payload)=>{
      const hz = typeof payload === "number" ? payload : (payload && payload.hz) || 0;
      if (!hz) return;
      if (infoEl){
        infoEl.innerHTML =
          "<strong>Realm:</strong> Nave â€¢ <strong>Tone:</strong> " + hz + " Hz â€¢ <strong>Overlay:</strong> stone-angels.png";
      }
    });

    // Soft default after load
    setTimeout(()=> setToneHz(432, { name:"Nave", element:"Aether", stylepack:"rosslyn_gothic" }), 600);

    // Export / share
    document.getElementById("btnSave")?.addEventListener("click", ()=>{
      exportCompositePNG({
        halo:"#cath-halo", relief:"#cath-relief",
        width:2160, height:1215,
        caption:    infoEl?.innerText || "Living Cathedral",
        subcaption: "Cathedral of Circuits â€¢ Codex 144:99"
      });
    });
    document.getElementById("btnShare")?.addEventListener("click", ()=>{
      const txt = infoEl?.innerText || "";
      const m = txt.match(/Tone:\s*(\d+)\s*Hz/i);
      const hz = m ? m[1] : 432;
      shareURL({ hz, room:"nave", alpha: Number(alpha?.value || 0.26) });
    });
    document.getElementById("btnClip")?.addEventListener("click", async ()=>{
      try { await recordCompositeWebM("#cath-halo", "#cath-relief", 6, 30); }
      catch(e){ alert("Recording not supported: " + e.message); }
    });
  </script>

  <!-- Planetary Hour (opt-in, ND-safe). Adds a gentle tint once/hour.
       This DOES NOTHING unless body[data-hourly="on"] is present. Safe to keep in place. -->
  <script>
    // feature flag: remove or toggle this attribute whenever you want
    document.body.setAttribute('data-hourly','on');
  </script>
  <script>
  (function(){
    if (document.body.getAttribute('data-hourly') !== 'on') return;

    var ORDER   = ["Saturn","Jupiter","Mars","Sun","Venus","Mercury","Moon"];
    var DAYRULE = {0:"Sun",1:"Moon",2:"Mars",3:"Mercury",4:"Jupiter",5:"Venus",6:"Saturn"};
    var TINT = {
      Saturn:"#2f2a38", Jupiter:"#3a2f1a", Mars:"#4a1f1f",
      Sun:"#f6e8b1", Venus:"#e6d5df", Mercury:"#cad6ef", Moon:"#e9eef2"
    };

    function applyPlanet(planet){
      var root = document.documentElement;
      var bg   = TINT[planet] || "#0b0d10";
      root.style.setProperty('--hour-bg', bg);
      if (!document.getElementById('hour-wash-style')){
        var st = document.createElement('style');
        st.id='hour-wash-style';
        st.textContent = `
          :root { --hour-bg: transparent; --hour-fade: .85s; }
          html, body { transition: background-color var(--hour-fade) ease, color var(--hour-fade) ease; }
          body { background-color: var(--hour-bg); }
        `;
        document.head.appendChild(st);
      }
    }

    function tick(){
      var now = new Date();
      var wd  = now.getDay(); // 0=Sun..6=Sat
      var hr  = now.getHours();
      var start = ORDER.indexOf(DAYRULE[wd]);     // fixed: correct lookup
      if (start < 0) start = 0;
      var idx = ((hr - 6) + start) % ORDER.length; // seed at ~06:00
      if (idx < 0) idx += ORDER.length;
      var planet = ORDER[idx];
      if (planet !== last){ applyPlanet(planet); last = planet; }
    }
    var last = "";
    tick();
    var timer = setInterval(tick, 60*1000);

    // rollback helper if anything feels off
    window.CodexHours = {
      off: function(){
        clearInterval(timer);
        document.documentElement.style.removeProperty('--hour-bg');
        var s = document.getElementById('hour-wash-style'); if (s) s.remove();
      }
    };
  })();
  </script>

  <!-- Hilma/rose overlay from SVG sprite (paths corrected) -->
  <div class="overlay-vitrail" id="overlay" aria-hidden="true"></div>
  <script type="module">
    import { mountOverlay } from "/assets/js/effects/overlay-loader.js";
    import { mountPlanetaryLight } from "/assets/js/effects/planetary-light.js";
    // IDs available in /assets/overlays/spiral-mandalas.svg: mandala-rose / mandala-spiral / mandala-vesica / mandala-altarpiece
    mountOverlay('#overlay', 'mandala-rose');
    mountPlanetaryLight('#overlay');
  </script>

  <!-- Fractal shader backdrop (GLSL syncs to tone) -->
  <div class="shader-backdrop" style="position:fixed;inset:0;z-index:-1;opacity:.45">
    <canvas id="fractal"></canvas>
  </div>
  <script type="module">
    import { mountFractalShader } from "/assets/js/engines/shader-engine.js";
    import { onToneChange } from "/assets/js/engines/ambient-engine.js";
    const update = await mountFractalShader(document.getElementById('fractal'), { kind:0, hue:210 });
    onToneChange(hz => {
      const hue  = 180 + (Number(hz)||0) % 180;          // simple mapping; refine later via correspondences
      const kind = hz<500 ? 1 : hz<650 ? 3 : 2;          // mandorla / rings / kaleid
      update && update({ hz, hue, kind });
    });
  </script>

  <!-- Footer nav (same pattern you use elsewhere) -->
  <footer class="site-footer" role="contentinfo">
    <nav aria-label="Site links">
      <ul>
        <li><a href="./index.html">âœ¦ Frontispiece (Door)</a></li>
        <li><a href="./cathedral.html">âœ¦ Cathedral Nave</a></li>
        <li><a href="./chapels/apprentice-pillar.html">Apprentice Pillar</a></li>
        <li><a href="./chapels/crypt.html">Crypt</a></li>
        <li><a href="./chapels/lady-chapel.html">Lady Chapel</a></li>
        <li><a href="./chapels/crystal-grid.html">Crystal Grid</a></li>
        <li><a href="./chapels/musical-cubes.html">Musical Cubes</a></li>
        <li><a href="./chapels/cubes-visual-lab.html">Cubes Visual Lab</a></li>
        <li><a href="./chapels/cosmogenesis/index.html">Cosmogenesis</a></li>
        <li><a href="./chapels/helix-totem.html">Jacobâ€™s Ladder</a></li>
        <li><a href="./chapels/shem-ladder.html">Shem Ladder (72)</a></li>
        <li><a href="./main/Thelemic-Alignment-Brief.html">Thelemic Alignment</a></li>
        <li><a href="./main/05_ateliers/manifesto.html">Ateliers Manifesto</a></li>
      </ul>
    </nav>
    <p class="seal">ð“‚€ âœ¦ Codex 144:99 âœ¦ ð“‚€</p>
  </footer>
</body>
</html>