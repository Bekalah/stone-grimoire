<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cathedral Engine -- I Ching Rose (Full Fusion)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="A museum-grade, ND-safe I Ching engine that fuses Double Tree paths, 72 Shem rotations, Soyga letter-lines, numerology, and planetary-hour tints into a living cathedral rose.">
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f8f5ef; --ink:#1b1a18; --muted:#6b6257; --line:#d8d0c5; --gold:#d4af37; --lapis:#2f5a9e; --card:#ffffff;
      --accent:#4d7bd1; --ok:#2f845f; --warn:#a8791b; --bad:#9e2d2d;

      /* Planetary tint fields (background halo only) */
      --tint: transparent;
      --t-saturn:#0b0f14; --t-jupiter:#fff0cc; --t-mars:#ffe1dc; --t-sun:#fff7d6; --t-venus:#f6e6ee; --t-mercury:#e8edf4; --t-moon:#dfe6f2;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1216; --ink:#ebe7df; --muted:#a79f95; --line:#2b2a27; --gold:#bba768; --lapis:#87a7ff; --card:#161a1f;
        --accent:#9fbaff; --ok:#5dd2a3; --warn:#ddb16b; --bad:#ff6b6b;

        --t-saturn:#0b0f14; --t-jupiter:#2a2518; --t-mars:#2a1b19; --t-sun:#2a261c; --t-venus:#2a2026; --t-mercury:#1b2128; --t-moon:#1e232b;
      }
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(100% 120% at 50% -10%, var(--tint) 0%, transparent 65%),
        var(--bg);
      font:16px/1.55 "Iowan Old Style", Georgia, serif;
    }
    a{color:var(--lapis);text-decoration:none}
    a:hover,a:focus{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:16px;align-items:baseline;flex-wrap:wrap}
    h1{font-size:1.6rem;color:var(--lapis);border-bottom:2px solid var(--gold);padding-bottom:.3rem;margin:.2rem 0 0}
    .note{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media (min-width:1000px){ .grid{grid-template-columns: 1.25fr .75fr} }
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .controls{display:grid;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}
    select,input[type="text"]{font:inherit;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    button{font:inherit;border:1px solid var(--line);background:var(--card);padding:8px 10px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--lapis);border-color:transparent;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:.15rem .6rem;background:var(--card)}
    .good{border-color:var(--ok);color:var(--ok)}
    .warn{border-color:var(--warn);color:var(--warn)}
    .bad{border-color:var(--bad);color:var(--bad)}
    .rose{position:relative;min-height:560px}
    canvas{display:block;width:100%;height:560px;background:transparent;border:1px solid var(--line);border-radius:12px}
    .meta{display:grid;gap:10px}
    .kv{display:grid;grid-template-columns: 140px 1fr;gap:10px;align-items:start}
    .kv strong{color:#3d3a34}
    @media (prefers-color-scheme: dark){ .kv strong{color:var(--ink)} }
    .small{font-size:.95rem;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:.85rem;border:1px solid var(--line);border-radius:999px;padding:.1rem .5rem}
    .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .cols2{columns:2;column-gap:16px}
    @media (max-width:800px){ .cols2{columns:1} }
    footer{margin-top:18px;color:var(--muted);font-size:.95rem}
    /* Planetary classes toggle --tint */
    .t-saturn{--tint:color-mix(in oklab,var(--t-saturn),transparent 70%)}
    .t-jupiter{--tint:color-mix(in oklab,var(--t-jupiter),transparent 70%)}
    .t-mars{--tint:color-mix(in oklab,var(--t-mars),transparent 70%)}
    .t-sun{--tint:color-mix(in oklab,var(--t-sun),transparent 70%)}
    .t-venus{--tint:color-mix(in oklab,var(--t-venus),transparent 70%)}
    .t-mercury{--tint:color-mix(in oklab,var(--t-mercury),transparent 70%)}
    .t-moon{--tint:color-mix(in oklab,var(--t-moon),transparent 70%)}
    .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body class="t-moon">
  <a class="sr-only" href="#main">Skip to content</a>
  <div class="wrap">
    <header>
      <h1>Cathedral Engine -- I Ching Rose</h1>
      <p class="note">A living <em>cathedral rose</em>: hexagram → Double Tree path (yin/yang) → Shem rotation → Soyga letters → numerology → planetary tint. ND-safe. Museum-grade.</p>
    </header>

    <main id="main" class="grid" role="main">
      <!-- Left: Canvas (Rose + Fractal) -->
      <section class="panel rose" aria-labelledby="viz">
        <h2 id="viz" class="sr-only">Rose Window Visualization</h2>
        <canvas id="rose" aria-label="I Ching rose viz"></canvas>
        <div class="cta">
          <button id="renderBtn" class="primary">Render Rose</button>
          <button id="randomBtn" title="Pick a random hexagram">Random Hexagram</button>
          <button data-tint="moon">Moon</button>
          <button data-tint="venus">Venus</button>
          <button data-tint="sun">Sun</button>
          <button data-tint="mercury">Mercury</button>
          <button data-tint="jupiter">Jupiter</button>
          <button data-tint="mars">Mars</button>
          <button data-tint="saturn">Saturn</button>
        </div>
        <p class="small">Planet buttons apply a subtle chapel tint -- no motion or audio autoplay; everything is gesture-gated. This atelier respects reduced-motion preferences.</p>
      </section>

      <!-- Right: Controls + Readouts -->
      <aside class="panel" aria-labelledby="controls">
        <h2 id="controls">Controls & Readouts</h2>
        <div class="controls" role="group" aria-label="I Ching & Cathedral controls">
          <div class="row">
            <label for="hex">Hexagram</label>
            <select id="hex" aria-label="I Ching hexagram selection"></select>
            <button id="flipBtn" title="Flip yin/yang polarity for path pairing">Flip Yin/Yang</button>
          </div>
          <div class="row">
            <label for="mode">Fractal Mode</label>
            <select id="mode" aria-label="Fractal mode">
              <option value="rose">Superformula Rose</option>
              <option value="lattice">Soyga Lattice</option>
              <option value="river">Abyssal River</option>
            </select>
          </div>
          <div class="row">
            <label for="seed">Seed</label>
            <input id="seed" type="text" placeholder="optional seed (letters/numbers)" aria-describedby="seedHelp">
          </div>
          <p id="seedHelp" class="small">Seed influences Soyga letters and geometry. Leave empty for deterministic by-hexagram render.</p>

          <div class="meta">
            <div class="kv"><strong>Hexagram:</strong> <span id="hname">--</span></div>
            <div class="kv"><strong>Lines (↓ bottom→top):</strong> <span id="hlines">--</span></div>
            <div class="kv"><strong>Double Tree Path:</strong> <span id="path">--</span></div>
            <div class="kv"><strong>Shem Rotation #:</strong> <span id="shem">--</span> <span class="small">(1–72)</span></div>
            <div class="kv"><strong>Soyga Letters:</strong> <span id="soyga">--</span></div>
            <div class="kv"><strong>Numerology:</strong> <span id="nums" class="chips"></span></div>
            <div class="badges" aria-label="Resonance badges">
              <span id="b11" class="badge">11</span>
              <span id="b22" class="badge">22</span>
              <span id="b33" class="badge">33</span>
              <span id="b72" class="badge">72</span>
              <span id="b99" class="badge">99</span>
              <span id="b144" class="badge">144</span>
            </div>
          </div>

          <details>
            <summary><strong>Cathedral Notes (what this page does)</strong></summary>
            <div class="cols2 small" style="margin-top:.5rem">
              <p><strong>64 → 32×2 bridge:</strong> Each hexagram maps to a Double Tree path with a chosen polarity (yin/yang). Flip to see the mirrored face.</p>
              <p><strong>72 Shem rotation:</strong> A deterministic spread places the hexagram-angle into a 72-step ring; use your angels72.json later to name it.</p>
              <p><strong>Soyga grid:</strong> Six lines pull six letters from a sacred alphabet stream; checksum reduces to a working number (1–9).</p>
              <p><strong>Fractal engines:</strong> Three renderers translate lines into geometry: Rose (superformula), Lattice (Soyga), River (Abyss flow).</p>
              <p><strong>Planet tint:</strong> Click a planet to re-hue the chapel subtly (no motion, ND-safe).</p>
            </div>
          </details>
        </div>
      </aside>
    </main>

    <section class="panel" aria-labelledby="readme" style="margin-top:16px">
      <h2 id="readme">Hermeneutic -- How the Fusion Works</h2>
      <ol>
        <li><strong>Pick a Hexagram.</strong> The six lines (broken = yin, solid = yang) become a 6-bit signature.</li>
        <li><strong>Map to Path.</strong> The signature resolves to one of <em>32</em> paths; yin/yang selects the mirrored face on the Double Tree.</li>
        <li><strong>Shem Rotation.</strong> The hexagram angle (0–360°) is quantized to <em>72</em> stations (decan ladder). This gives you an angel/daimon index.</li>
        <li><strong>Soyga Letters.</strong> A seeded stream yields six letters (one per line). The line state picks from two alphabets; checksum produces a working number.</li>
        <li><strong>Fractal Geometry.</strong> The line pattern drives geometry: petals, lattice, or river. Same truth; different vestments.</li>
        <li><strong>Planetary Hour.</strong> Use the tint buttons to emulate the current hour; your chapel engine can flip these automatically by location/time.</li>
      </ol>
      <p class="small">This page is self-contained and safe to export. It expects zero network or audio autoplay. Screen-reader labels are provided. Motion is minimal and user-controlled.</p>
    </section>

    <footer>
      <p>Stone-Grimoire · Circuitum 99 · Cathedral Engine -- I Ching Rose. License: CC0 for structure and code. Hexagram names are provided for study use.</p>
    </footer>
  </div>

  <script>
  ;(function(){
    "use strict";

    // ====== DATA: 64 Hexagrams (ID, Name, Pinyin, Trigrams) ======
    // Lines are stored as array of 6 booleans bottom->top (true=yang solid, false=yin broken)
    // Names per common English renderings (study use).
    const HEX = [
      {id:1,  name:"The Creative", pinyin:"Qián", trigram:["Heaven","Heaven"], lines:[1,1,1,1,1,1]},
      {id:2,  name:"The Receptive", pinyin:"Kūn", trigram:["Earth","Earth"], lines:[0,0,0,0,0,0]},
      {id:3,  name:"Difficulty at the Beginning", pinyin:"Zhūn", trigram:["Water","Thunder"], lines:[0,1,0,0,0,1]},
      {id:4,  name:"Youthful Folly", pinyin:"Méng", trigram:["Mountain","Water"], lines:[1,0,0,0,1,0]},
      {id:5,  name:"Waiting (Nourishment)", pinyin:"Xū", trigram:["Water","Heaven"], lines:[0,0,1,1,1,0]},
      {id:6,  name:"Conflict", pinyin:"Sòng", trigram:["Heaven","Water"], lines:[1,1,1,0,0,1]},
      {id:7,  name:"The Army", pinyin:"Shī", trigram:["Earth","Water"], lines:[0,0,0,0,0,1]},
      {id:8,  name:"Holding Together (Union)", pinyin:"Bǐ", trigram:["Water","Earth"], lines:[0,0,1,0,0,0]},
      {id:9,  name:"The Taming Power of the Small", pinyin:"Xiǎo Chù", trigram:["Wind","Heaven"], lines:[1,1,0,1,1,1]},
      {id:10, name:"Treading (Conduct)", pinyin:"Lǚ", trigram:["Heaven","Lake"], lines:[1,1,1,1,1,0]},
      {id:11, name:"Peace", pinyin:"Tài", trigram:["Earth","Heaven"], lines:[0,0,0,1,1,1]},
      {id:12, name:"Standstill (Stagnation)", pinyin:"Pǐ", trigram:["Heaven","Earth"], lines:[1,1,1,0,0,0]},
      {id:13, name:"Fellowship with Men", pinyin:"Tóng Rén", trigram:["Heaven","Fire"], lines:[1,1,1,1,0,1]},
      {id:14, name:"Possession in Great Measure", pinyin:"Dà Yǒu", trigram:["Fire","Heaven"], lines:[1,0,1,1,1,1]},
      {id:15, name:"Modesty", pinyin:"Qiān", trigram:["Earth","Mountain"], lines:[0,0,0,1,0,0]},
      {id:16, name:"Enthusiasm", pinyin:"Yù", trigram:["Thunder","Earth"], lines:[0,1,1,0,0,0]},
      {id:17, name:"Following", pinyin:"Suí", trigram:["Lake","Thunder"], lines:[0,1,1,1,1,0]},
      {id:18, name:"Work on the Decayed", pinyin:"Gǔ", trigram:["Mountain","Wind"], lines:[1,0,0,0,1,1]},
      {id:19, name:"Approach", pinyin:"Lín", trigram:["Earth","Lake"], lines:[0,0,0,1,1,0]},
      {id:20, name:"Contemplation (View)", pinyin:"Guān", trigram:["Wind","Earth"], lines:[1,1,0,0,0,0]},
      {id:21, name:"Biting Through", pinyin:"Shì Kè", trigram:["Fire","Thunder"], lines:[1,0,1,0,1,0]},
      {id:22, name:"Grace", pinyin:"Bì", trigram:["Mountain","Fire"], lines:[1,0,0,1,0,1]},
      {id:23, name:"Splitting Apart", pinyin:"Bō", trigram:["Mountain","Earth"], lines:[1,0,0,0,0,0]},
      {id:24, name:"Return (The Turning Point)", pinyin:"Fù", trigram:["Earth","Thunder"], lines:[0,0,0,0,1,0]},
      {id:25, name:"Innocence (The Unexpected)", pinyin:"Wú Wàng", trigram:["Heaven","Thunder"], lines:[1,1,1,1,1,0]},
      {id:26, name:"Taming Power of the Great", pinyin:"Dà Chù", trigram:["Mountain","Heaven"], lines:[1,0,0,1,1,1]},
      {id:27, name:"Nourishment", pinyin:"Yí", trigram:["Mountain","Thunder"], lines:[1,0,0,0,1,0]},
      {id:28, name:"Preponderance of the Great", pinyin:"Dà Guò", trigram:["Lake","Wind"], lines:[0,0,1,1,0,0]},
      {id:29, name:"The Abysmal (Water)", pinyin:"Kǎn", trigram:["Water","Water"], lines:[0,1,0,0,1,0]},
      {id:30, name:"The Clinging (Fire)", pinyin:"Lí", trigram:["Fire","Fire"], lines:[1,0,1,1,0,1]},
      {id:31, name:"Influence (Wooing)", pinyin:"Xián", trigram:["Lake","Mountain"], lines:[1,0,1,0,0,0]},
      {id:32, name:"Duration", pinyin:"Héng", trigram:["Thunder","Wind"], lines:[0,1,1,1,0,1]},
      {id:33, name:"Retreat", pinyin:"Dùn", trigram:["Heaven","Mountain"], lines:[1,1,1,1,0,0]},
      {id:34, name:"Power of the Great", pinyin:"Dà Zhuàng", trigram:["Thunder","Heaven"], lines:[0,1,1,1,1,1]},
      {id:35, name:"Progress", pinyin:"Jìn", trigram:["Fire","Earth"], lines:[1,0,1,0,0,0]},
      {id:36, name:"Darkening of the Light", pinyin:"Míng Yí", trigram:["Earth","Fire"], lines:[0,0,0,1,0,1]},
      {id:37, name:"Family (The Clan)", pinyin:"Jiā Rén", trigram:["Wind","Fire"], lines:[1,1,0,1,0,1]},
      {id:38, name:"Opposition", pinyin:"Kuí", trigram:["Fire","Lake"], lines:[1,0,1,1,1,0]},
      {id:39, name:"Obstruction", pinyin:"Jiǎn", trigram:["Water","Mountain"], lines:[0,0,1,0,0,1]},
      {id:40, name:"Deliverance", pinyin:"Xiè", trigram:["Thunder","Water"], lines:[0,1,1,0,0,1]},
      {id:41, name:"Decrease", pinyin:"Sǔn", trigram:["Mountain","Lake"], lines:[1,0,0,1,1,0]},
      {id:42, name:"Increase", pinyin:"Yì", trigram:["Wind","Thunder"], lines:[1,1,0,0,1,1]},
      {id:43, name:"Breakthrough (Resoluteness)", pinyin:"Guài", trigram:["Lake","Heaven"], lines:[0,0,1,1,1,1]},
      {id:44, name:"Coming to Meet", pinyin:"Gòu", trigram:["Heaven","Wind"], lines:[1,1,1,0,1,1]},
      {id:45, name:"Gathering Together (Massing)", pinyin:"Cuí", trigram:["Lake","Earth"], lines:[0,0,1,0,0,0]},
      {id:46, name:"Pushing Upward", pinyin:"Shēng", trigram:["Earth","Wind"], lines:[0,0,0,0,1,1]},
      {id:47, name:"Oppression (Exhaustion)", pinyin:"Kùn", trigram:["Lake","Water"], lines:[0,0,1,0,0,1]},
      {id:48, name:"The Well", pinyin:"Jǐng", trigram:["Water","Wind"], lines:[0,0,1,1,0,1]},
      {id:49, name:"Revolution (Molting)", pinyin:"Gé", trigram:["Lake","Fire"], lines:[0,0,1,1,0,1]}, // alt mappings often vary
      {id:50, name:"The Cauldron", pinyin:"Dǐng", trigram:["Fire","Wind"], lines:[1,0,1,1,0,0]},
      {id:51, name:"The Arousing (Shock, Thunder)", pinyin:"Zhèn", trigram:["Thunder","Thunder"], lines:[0,1,0,1,0,1]},
      {id:52, name:"Keeping Still (Mountain)", pinyin:"Gèn", trigram:["Mountain","Mountain"], lines:[1,0,0,1,0,0]},
      {id:53, name:"Development (Gradual Progress)", pinyin:"Jiàn", trigram:["Wind","Mountain"], lines:[1,1,0,1,0,0]},
      {id:54, name:"The Marrying Maiden", pinyin:"Guī Mèi", trigram:["Thunder","Lake"], lines:[0,1,1,0,1,1]},
      {id:55, name:"Abundance (Fullness)", pinyin:"Fēng", trigram:["Thunder","Fire"], lines:[0,1,1,1,0,0]},
      {id:56, name:"The Wanderer", pinyin:"Lǚ", trigram:["Fire","Mountain"], lines:[1,0,1,0,0,0]}, // simplification
      {id:57, name:"The Gentle (Wind, Penetrating)", pinyin:"Xùn", trigram:["Wind","Wind"], lines:[1,1,0,1,1,0]},
      {id:58, name:"The Joyous (Lake)", pinyin:"Duì", trigram:["Lake","Lake"], lines:[0,0,1,0,0,1]},
      {id:59, name:"Dispersion (Dissolution)", pinyin:"Huàn", trigram:["Wind","Water"], lines:[1,1,0,0,1,0]},
      {id:60, name:"Limitation", pinyin:"Jié", trigram:["Water","Lake"], lines:[0,1,0,0,0,1]},
      {id:61, name:"Inner Truth", pinyin:"Zhōng Fú", trigram:["Wind","Lake"], lines:[1,1,0,0,0,1]},
      {id:62, name:"Preponderance of the Small", pinyin:"Xiǎo Guò", trigram:["Thunder","Mountain"], lines:[0,1,1,0,0,0]},
      {id:63, name:"After Completion", pinyin:"Jì Jì", trigram:["Water","Fire"], lines:[0,1,0,1,0,1]},
      {id:64, name:"Before Completion", pinyin:"Wèi Jì", trigram:["Fire","Water"], lines:[1,0,1,0,1,0]}
    ];

    // ====== DATA: 32 Path names (placeholder canonical order 1..32) ======
    // We map hex id -> path index with a deterministic weave; flip toggles the yin/yang face.
    const PATHS = [
      "Aleph","Beth","Gimel","Daleth","Heh","Vav","Zain","Cheth","Teth","Yod","Kaph","Lamed",
      "Mem","Nun","Samekh","Ayin","Pe","Tzaddi","Qoph","Resh","Shin","Tav",
      "Path-23","Path-24","Path-25","Path-26","Path-27","Path-28","Path-29","Path-30","Path-31","Path-32"
    ];

    // Sacred alphabets for Soyga sampling (two 22-letter streams for yin/yang blend)
    const ALPHA_YANG = "ABGDEHVZChTIKLMNSOPhTZ".split("");   // translit-ish stream (22)
    const ALPHA_YIN  = "abcdefghijklmnopqrstuvwxyz".slice(0,22).toUpperCase().split("");

    // ====== DOM ======
    const elHex = document.getElementById("hex");
    const elHName = document.getElementById("hname");
    const elHLines = document.getElementById("hlines");
    const elPath = document.getElementById("path");
    const elShem = document.getElementById("shem");
    const elSoyga = document.getElementById("soyga");
    const elNums = document.getElementById("nums");
    const badge = id => document.getElementById(id);

    const elSeed = document.getElementById("seed");
    const elMode = document.getElementById("mode");
    const elFlip = document.getElementById("flipBtn");
    const elRender = document.getElementById("renderBtn");
    const elRandom = document.getElementById("randomBtn");

    const canvas = document.getElementById("rose");
    const ctx = canvas.getContext("2d");

    // Resize canvas to device pixel ratio for crispness
    function fitCanvas(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = canvas.clientWidth;
      const h = 560;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", fitCanvas);
    fitCanvas();

    // Populate dropdown
    HEX.forEach(h => {
      const o = document.createElement("option");
      o.value = String(h.id);
      o.textContent = `${h.id.toString().padStart(2,"0")} -- ${h.name} (${h.pinyin})`;
      elHex.appendChild(o);
    });

    // State
    let state = {
      hexId: 2,
      flipped: false,
      mode: "rose",
      seed: ""
    };

    // Helpers
    const sumDigits = n => String(n).split("").reduce((a,c)=>a+(+c),0);
    function mod(a,m){ return ((a % m) + m) % m; }

    // Map hexagram to path index (0..31) using a weave of lower and upper trigrams and parity
    function mapHexToPathIndex(hex){
      // Build a 6-bit int from lines
      const bits = hex.lines.reduce((acc,b,i)=> acc | ((b?1:0)<<i), 0);
      // Simple weave: (lower3 * 9 + upper3 * 3 + parity) mod 32
      const lower = bits & 0b111;            // lines 0..2
      const upper = (bits >> 3) & 0b111;     // lines 3..5
      const parity = (bits.toString(2).replace(/0/g,"").length) & 1; // count yang lines parity
      const idx = mod(lower*9 + upper*3 + parity, 32);
      return idx;
    }

    // Shem rotation: map 64 hex positions around a circle into 72-step ring (1..72)
    function mapHexToShemIndex(id){
      const angle = (id-1) * (360/64);
      const idx = Math.floor((angle / 360) * 72) + 1;
      return Math.min(72, Math.max(1, idx));
    }

    // Soyga letters from lines and seed
    function soygaFromLines(lines, seed){
      // Create a deterministic PRNG from seed + lines using xorshift-ish
      let h = 2166136261 >>> 0;
      const s = (seed||"").toUpperCase() + lines.map(b=>b?1:0).join("");
      for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
      function r(){
        h ^= h<<13; h ^= h>>>17; h ^= h<<5; h >>>= 0;
        return h/0xFFFFFFFF;
      }
      const out = [];
      for(let i=0;i<6;i++){
        const yin = lines[i] ? 0 : 1; // broken -> yin set
        const set = yin ? ALPHA_YIN : ALPHA_YANG;
        out.push(set[Math.floor(r()*set.length)]);
      }
      // checksum: simple Hebrew-ish values (A=1.., treat non-mapped as 0)
      const vals = {};
      "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach((ch,i)=> vals[ch]=i+1);
      const sum = out.reduce((a,c)=>a+(vals[c]||0),0);
      const red = ((n)=>{ while(n>9) n = sumDigits(n); return n; })(sum);
      return {letters: out.join(""), checksum: sum, reduction: red};
    }

    // Numerology badges activator
    function setBadges(n){
      const hits = {
        b11: n===11 || n===2 || n===20 || n===29, // playful harmonics
        b22: n===22 || n===4 || n===13,
        b33: n===33 || n===6,
        b72: true, // ladder always in play
        b99: (n===9 || n===18 || n===27),
        b144: (n===9) // 1+4+4=9
      };
      Object.keys(hits).forEach(k=>{
        const el = badge(k);
        el.classList.remove("good","warn","bad");
        if(hits[k]) el.classList.add("good");
      });
    }

    // Renderers
    function clearCanvas(){
      const {width:w, height:h} = canvas;
      ctx.clearRect(0,0,w,h);
      // faint guide
      ctx.save();
      ctx.translate(w/2, h/2);
      ctx.strokeStyle = "rgba(128,128,128,.25)";
      ctx.beginPath();
      ctx.arc(0,0, Math.min(w,h)*0.35, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    function drawRose(hex, soyga, flip){
      clearCanvas();
      const {width:w, height:h} = canvas;
      const R = Math.min(w,h)*0.42;
      ctx.save(); ctx.translate(w/2, h/2);

      // Base superformula-like petals from line pattern
      const L = hex.lines.slice();
      if(flip){ L.reverse(); }
      const yangCount = L.filter(Boolean).length;
      const petalCount = 6 + yangCount; // 6..12
      const twist = (L[0]?1:-1) * (L[5]?1:-1) * 0.6;

      ctx.beginPath();
      for(let a=0; a<=Math.PI*2+0.001; a+=0.006){
        // Superformula-ish radius
        const m = petalCount;
        const n1=0.3 + (yangCount/12);
        const n2=0.2 + (L[1]?0.35:0.1);
        const n3=0.2 + (L[4]?0.35:0.1);
        const r = Math.pow( Math.pow(Math.abs(Math.cos(m*a/4)), n2) + Math.pow(Math.abs(Math.sin(m*a/4)), n3), -1/n1 );
        const rr = (R*0.45 + R*0.45*r) * (1 + twist * Math.sin(a*2));
        const x = rr * Math.cos(a);
        const y = rr * Math.sin(a);
        if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.closePath();
      ctx.fillStyle = "rgba(212,175,55,0.12)";
      ctx.fill();
      ctx.strokeStyle = "rgba(77,123,209,0.5)";
      ctx.lineWidth = 1.25;
      ctx.stroke();

      // Soyga ring
      const letters = soyga.letters.split("");
      ctx.save();
      const ringR = R*0.62;
      ctx.strokeStyle = "rgba(77,123,209,0.25)";
      ctx.beginPath(); ctx.arc(0,0, ringR, 0, Math.PI*2); ctx.stroke();
      ctx.fillStyle = "currentColor";
      ctx.font = "14px ui-monospace, Menlo, Consolas, monospace";
      for(let i=0;i<letters.length;i++){
        const a = -Math.PI/2 + i*(Math.PI*2/letters.length);
        const x = ringR*Math.cos(a), y = ringR*Math.sin(a);
        ctx.save(); ctx.translate(x,y); ctx.rotate(a+Math.PI/2);
        ctx.fillText(letters[i], -4, 4);
        ctx.restore();
      }
      ctx.restore();

      // Six line-bars in inner wheel (bottom to top)
      const innerR = R*0.28;
      for(let i=0;i<6;i++){
        const a = -Math.PI/2 + i*(Math.PI/3);
        const len = L[i]? 52 : 20; // yang longer
        ctx.save(); ctx.rotate(a);
        ctx.strokeStyle = L[i] ? "rgba(47,90,158,0.9)" : "rgba(47,90,158,0.45)";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(innerR, 0);
        ctx.lineTo(innerR+len, 0);
        ctx.stroke();
        // yin gap
        if(!L[i]){
          ctx.beginPath();
          ctx.moveTo(innerR+len+10, 0);
          ctx.lineTo(innerR+len+30, 0);
          ctx.stroke();
        }
        ctx.restore();
      }

      // Center seal (numerology)
      ctx.fillStyle = "rgba(0,0,0,.65)";
      ctx.globalAlpha = 0.8;
      ctx.beginPath(); ctx.arc(0,0, 22, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#fff";
      ctx.font = "bold 16px Georgia, serif";
      ctx.textAlign = "center";
      ctx.fillText(String(soyga.reduction), 0, 6);

      ctx.restore();
    }

    function drawLattice(hex, soyga, flip){
      clearCanvas();
      const {width:w,height:h} = canvas;
      const cols = 6, rows = 6;
      const cell = Math.min(w/(cols+2), h/(rows+2));
      const ox = (w - cols*cell)/2;
      const oy = (h - rows*cell)/2;

      ctx.save();
      ctx.lineWidth = 1;
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          const idx = y; // map line per row
          const isYang = (flip? hex.lines[5-idx] : hex.lines[idx]) ? 1 : 0;
          const gx = Math.floor((x + (isYang? (y%2) : 0)) % cols);
          const gy = y;
          const X = ox + (gx)*cell;
          const Y = oy + (gy)*cell;
          ctx.strokeStyle = "rgba(0,0,0,.25)";
          ctx.strokeRect(X, Y, cell, cell);

          // fill pattern
          ctx.save();
          ctx.translate(X+cell/2, Y+cell/2);
          ctx.rotate(((x+y)%2?1:-1) * 0.2);
          ctx.fillStyle = isYang ? "rgba(212,175,55,.25)" : "rgba(77,123,209,.18)";
          for(let k=0;k<3;k++){
            ctx.beginPath();
            ctx.arc(0,0, cell*(0.15 + k*0.12), 0, Math.PI*2);
            ctx.fill();
          }
          ctx.restore();
        }
      }
      // Write Soyga letters across diagonal
      ctx.fillStyle = "currentColor";
      ctx.font = "bold 18px ui-monospace, Menlo, Consolas, monospace";
      const L = soyga.letters.split("");
      for(let i=0;i<L.length;i++){
        const X = ox + (i)*(cell+2) + cell/3;
        const Y = oy + (i)*(cell) + cell/1.6;
        ctx.fillText(L[i], X, Y);
      }
      ctx.restore();
    }

    function drawRiver(hex, soyga, flip){
      clearCanvas();
      const {width:w, height:h} = canvas;
      ctx.save();
      ctx.translate(0, h*0.1);

      // A Bezier "river" whose meanders are driven by the line pattern
      const L = flip ? hex.lines.slice().reverse() : hex.lines.slice();
      const segments = 12;
      const dx = w/segments;
      let x = 0, y = h*0.4;
      ctx.beginPath(); ctx.moveTo(x,y);
      for(let i=0;i<segments;i++){
        const l = L[i%6];
        const amp = l ? h*0.15 : h*0.07;
        const ctrl1 = {x: x+dx*0.33, y: y + amp*(Math.sin(i*1.2))};
        const ctrl2 = {x: x+dx*0.66, y: y - amp*(Math.cos(i*0.9))};
        const ny = y + amp*(l? -0.6 : 0.6);
        const nx = x + dx;
        ctx.bezierCurveTo(ctrl1.x,ctrl1.y, ctrl2.x,ctrl2.y, nx, ny);
        x=nx; y=ny;
      }
      ctx.lineWidth = 18; ctx.strokeStyle = "rgba(47,90,158,0.18)"; ctx.stroke();
      ctx.lineWidth = 6; ctx.strokeStyle = "rgba(47,90,158,0.55)"; ctx.stroke();

      // Floating Soyga letters as stones
      ctx.fillStyle = "rgba(212,175,55,.9)";
      ctx.font = "bold 16px ui-monospace, Menlo, Consolas, monospace";
      const letters = soyga.letters.split("");
      for(let i=0;i<letters.length;i++){
        const px = (i+1) * (w/(letters.length+1));
        const py = h*0.25 + (i%2? -20: 20);
        ctx.fillText(letters[i], px-6, py);
      }
      ctx.restore();
    }

    function render(){
      const hex = HEX.find(h=>h.id===state.hexId);
      if(!hex) return;

      // Readouts
      elHName.textContent = `${hex.id} -- ${hex.name} (${hex.pinyin})`;
      elHLines.textContent = hex.lines.map(b=> b? "--" : "– –").join("  ");
      const pathIdx = mapHexToPathIndex(hex);
      const pathName = PATHS[pathIdx] || `Path-${pathIdx+1}`;
      elPath.textContent = `${pathName}${state.flipped? " (yin-face)": " (yang-face)"}`;
      const shemIdx = mapHexToShemIndex(hex.id);
      elShem.textContent = String(shemIdx);

      // Soyga
      const soyga = soygaFromLines(hex.lines, (state.seed||"") + (state.flipped? "YIN":"YANG"));
      elSoyga.textContent = `${soyga.letters} · Σ=${soyga.checksum} → ${soyga.reduction}`;
      setBadges(soyga.reduction);

      // Numerology chips detail
      elNums.innerHTML = "";
      const chips = [
        {k:"Σ", v: soyga.checksum},
        {k:"→", v: soyga.reduction}
      ];
      chips.forEach(c=>{
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = `${c.k} ${c.v}`;
        elNums.appendChild(span);
      });

      // Draw
      if(state.mode==="rose") drawRose(hex, soyga, state.flipped);
      else if(state.mode==="lattice") drawLattice(hex, soyga, state.flipped);
      else drawRiver(hex, soyga, state.flipped);
    }

    // Events
    elHex.addEventListener("change", ()=>{
      state.hexId = parseInt(elHex.value,10);
      render();
    });
    elMode.addEventListener("change", ()=>{
      state.mode = elMode.value;
      render();
    });
    elSeed.addEventListener("input", ()=>{
      state.seed = elSeed.value;
      render();
    });
    elFlip.addEventListener("click", ()=>{
      state.flipped = !state.flipped;
      render();
    });
    elRender.addEventListener("click", render);
    elRandom.addEventListener("click", ()=>{
      const r = 1 + Math.floor(Math.random()*64);
      state.hexId = r; elHex.value = String(r);
      render();
    });

    // Planet tints
    document.querySelectorAll('button[data-tint]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const t = b.getAttribute('data-tint');
        document.body.classList.remove("t-saturn","t-jupiter","t-mars","t-sun","t-venus","t-mercury","t-moon");
        document.body.classList.add("t-"+t);
      });
    });

    // Init selection and render
    elHex.value = String(state.hexId);
    render();
  })();
  </script>
</body>
</html>