<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Temple -- Cosmogenesis Engine</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../assets/css/palette.css">
<link rel="stylesheet" href="../assets/css/light.css">
<style>
  body{margin:0;background:var(--bg);color:var(--ink);font:18px/1.6 Georgia,serif}
  header, .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{margin-top:12px;background:var(--wash);border:1px solid var(--line);border-radius:12px}
  .canvas-frame{position:relative; margin:12px 0; border-radius:12px; overflow:hidden; border:1px solid var(--line)}
  #fractal{width:100%;height:58vh; display:block; background:#0a0a0a}
  #hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button{font:16px/1 ui-sans-serif,system-ui;padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:.15rem .6rem;background:#f6f2e9}
</style>
</head>
<body class="mystic" data-theme="tiphereth">
<header>
  <h1>Temple -- Cosmogenesis</h1>
  <p>Fractal cosmograms + harmonic beats tied to Aeons/Spheres. ND‑safe; sponsor‑grade.</p>
  <div id="hud">
    <label>Aeon:
      <select id="aeonSel"></select>
    </label>
    <button id="play">Start</button>
    <button id="stop">Stop</button>
    <span id="readout" class="pill">--</span>
    <a class="pill" href="../cathedral.html">← Back to Nave</a>
  </div>
</header>

<div class="wrap">
  <div class="canvas-frame">
    <canvas id="fractal"></canvas>
  </div>
  <p class="tiny">Sound is gated by your click. No strobe, smooth fades, soft limiter. Headphones recommended.</p>
</div>

<script type="module">
  import { startFractal } from "../assets/js/engines/fractal-engine.js";
  import { startBeat, stopBeat, setBpm } from "../assets/js/engines/beat-engine.js";
  import { ensureAudio, primeAudio, startTone, stopTone, setHz, loadIR } from "../assets/js/ambient-engine.js";
  import { startAureole } from "../assets/js/components/aureole-engine.js";

  const sel = document.getElementById('aeonSel');
  const btnPlay = document.getElementById('play');
  const btnStop = document.getElementById('stop');
  const readout = document.getElementById('readout');
  const cv = document.getElementById('fractal');

  const scenes = await fetch("../assets/data/scenes.json",{cache:'no-store'}).then(r=>r.json());
  const aeons = scenes.aeons;

  // populate select
  for (const a of aeons){
    const o = document.createElement('option');
    o.value = a.id; o.textContent = a.title;
    sel.appendChild(o);
  }
  sel.value = "tiphereth";

  let fractal;
  let current = aeons.find(a=>a.id===sel.value) || aeons[0];

  function setScene(a){
    current = a;
    setHz(a.toneHz, 160);
    setBpm(a.bpm);
    const kindMap = { spiral:0, mandorla:1, kaleid:2, rings:3, cone:4 };
    const k = kindMap[a.fractal.kind] ?? 0;
    fractal.set({
      hz: a.toneHz,
      bpm: a.bpm,
      detail: a.fractal.detail,
      glow: a.fractal.glow,
      hue: a.fractal.hue,
      kind: k
    });
    readout.textContent = `${a.title} · ${a.bpm}bpm · ${a.toneHz}Hz`;
  }

  async function boot(){
    await ensureAudio(); await primeAudio(current.toneHz);
    try { await loadIR('../assets/audio/ir/cathedral_small.wav'); } catch {}
    fractal = await startFractal(cv, { hz: current.toneHz, bpm: current.bpm, kind: 0 });
    setScene(current);
  }
  boot();

  sel.addEventListener('change', ()=>{
    const a = aeons.find(x=>x.id===sel.value) || current;
    setScene(a);
  });

  btnPlay.addEventListener('click', async ()=>{
    await ensureAudio();
    startTone(current.toneHz);
    startBeat({ bpmIn: current.bpm, toneHz: current.toneHz });
  });

  btnStop.addEventListener('click', ()=>{
    stopBeat(); stopTone();
  });
</script>
</body>
</html>